# ------------------------------------------------------------------------
# Custom Security Rules for Enhanced Protection
# ID Range: 990000 - 990010 (Safe for Custom Rules)
# ------------------------------------------------------------------------

#
# [1] CSRF Protection (Referer Check)
# ID: 990001
# POST 요청에서 Referer 헤더가 없거나 서버 도메인과 다르면 차단 (CSRF 공격 방지)
#
SecRule REQUEST_METHOD "POST" \
    "id:990001,\
    phase:1,\
    t:none,\
    block,\
    log,\
    msg:'CSRF Attack Detected: Missing or Invalid Referer/Origin',\
    tag:'OWASP_TOP_10/A01',\
    chain"
    SecRule REQUEST_HEADERS:Referer "@rx ^http(s)?://%{SERVER_NAME}/" \
        "t:none,negate"


#
# [2] Mishandling of Exceptional Conditions (Information Leakage)
# ID: 990002
# 응답 본문에서 Fatal error, SQL syntax error 등 예외처리 메시지 패턴이 감지되면 차단 및 로그 기록
#
SecRule RESPONSE_BODY "@rx (?i)(fatal error|sql syntax|ora-[0-9]+|microsoft ole db provider|stack trace|unclosed quotation mark|syntax error at|unexpected end of file)" \
    "id:990002,\
    phase:4,\
    t:none,\
    block,\
    log,\
    msg:'Information Leakage: Application Error Message Detected',\
    tag:'OWASP_TOP_10/A05',\
    setvar:'tx.anomaly_score_pl1=+%{tx.critical_anomaly_score}'"


#
# [3] A04 Cryptographic Failures - File Access Control
# ID: 990003
# .pem, .key, .env 등 민감한 암호화/환경 설정 파일에 대한 접근 시도 차단
#
SecRule REQUEST_FILENAME "@rx \.(?:pem|key|crt|env|p12|pfx|asc|jks)$" \
    "id:990003,\
    phase:1,\
    t:none,t:lowercase,\
    block,\
    log,\
    msg:'Cryptographic Failures: Attempt to Access Sensitive Key/Config File',\
    tag:'OWASP_TOP_10/A04',\
    setvar:'tx.anomaly_score_pl1=+%{tx.critical_anomaly_score}'"


#
# [4] A04 Cryptographic Failures - Private Key Leakage
# ID: 990004
# 응답 본문에서 RSA나 DSA 개인키(-----BEGIN PRIVATE KEY-----) 노출 감지 시 차단 및 로그 기록
#
SecRule RESPONSE_BODY "@rx -----BEGIN [A-Z]+ PRIVATE KEY-----" \
    "id:990004,\
    phase:4,\
    t:none,\
    block,\
    log,\
    msg:'Cryptographic Failures: Private Key Leakage Detected',\
    tag:'OWASP_TOP_10/A04',\
    setvar:'tx.anomaly_score_pl1=+%{tx.critical_anomaly_score}'"


#
# [5] A04 Cryptographic Failures - Cleartext Password Pattern Leakage
# ID: 990005
# JSON/XML 등 응답 본문 내에 "password" 또는 유사 키명 뒤에 실제 비밀번호 패턴 평문 노출 감지 시 차단 및 로그
#
SecRule RESPONSE_BODY "@rx (?i)(?:\"|')(?:password|passwd|pwd|secret)(?:\"|')\s*[:=]\s*(?:\"|')[^\"']{3,}(?:\"|')" \
    "id:990005,\
    phase:4,\
    t:none,\
    block,\
    log,\
    msg:'Cryptographic Failures: Potential Cleartext Password Leakage',\
    tag:'OWASP_TOP_10/A04',\
    setvar:'tx.anomaly_score_pl1=+%{tx.critical_anomaly_score}'"


#
# [6] Brute Force Attack Detection - Rate Limiting for Login Attempts
# ID: 990006, 990007, 990008
# 동일 IP에서 짧은 시간 (30초) 내 10회 이상 로그인 시도 감지 시 차단 및 로그
# username, password, user, login 등 로그인 관련 파라미터가 포함된 POST 요청 대상
#
SecRule REQUEST_METHOD "POST" \
    "chain, \
    id:990006, \
    phase:2, \
    t:none, \
    block, \
    log, \
    msg:'Brute Force Attack Detected - Excessive Login Attempts', \
    tag:'OWASP_TOP_10/A07'"

SecRule ARGS_NAMES|ARGS "@pm username password passwd user login" \
    "t:none"

SecAction \
    "id:990007, \
    phase:1, \
    nolog, \
    pass, \
    initcol:ip=%{REMOTE_ADDR}, \
    setvar:ip.bruteforce_count=+1, \
    expirevar:ip.bruteforce_count=30"

SecRule IP:BRUTEFORCE_COUNT "@gt 10" \
    "id:990008, \
    phase:1, \
    block, \
    log, \
    msg:'Brute Force Attack Detected - Too Many Login Attempts from IP', \
    tag:'OWASP_TOP_10/A07'"
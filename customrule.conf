# ------------------------------------------------------------------------
# Custom Security Rules for Enhanced Protection (LOG ONLY VERSION)
# ID Range: 990000 - 990010
# ------------------------------------------------------------------------


#
# [1] CSRF Protection (Referer Check) - LOG ONLY (no Referer)
# POST 요청인데 Referer 헤더가 없으면 탐지 후 로그만
#
SecRule REQUEST_METHOD "POST" \
    "id:990001,\
    phase:1,\
    t:none,\
    pass,\
    log,\
    msg:'CSRF Attack Detected: Missing Referer Header (LOG ONLY)',\
    tag:'OWASP_TOP_10/A01',\
    chain"
    SecRule &REQUEST_HEADERS:Referer "@eq 0" \
        "t:none"



#
# [2] Mishandling of Exceptional Conditions (Information Leakage) - LOG ONLY
# 예외 메시지 패턴 감지 시 차단 없이 로그만 기록
#
SecRule RESPONSE_BODY "@rx (?i)(fatal error|sql syntax|ora-[0-9]+|microsoft ole db provider|stack trace|unclosed quotation mark|syntax error at|unexpected end of file)" \
    "id:990002,\
    phase:4,\
    t:none,\
    pass,\
    log,\
    msg:'Information Leakage: Application Error Message Detected (LOG ONLY)',\
    tag:'OWASP_TOP_10/A05',\
    setvar:'tx.anomaly_score_pl1=+%{tx.critical_anomaly_score}'"



#
# [3] A04 Cryptographic Failures - File Access Control - LOG ONLY
# 민감한 암호화/환경 설정 파일 접근 시도 탐지 후 로그만
#
SecRule REQUEST_FILENAME "@rx \.(?:pem|key|crt|env|p12|pfx|asc|jks)$" \
    "id:990003,\
    phase:1,\
    t:none,t:lowercase,\
    pass,\
    log,\
    msg:'Cryptographic Failures: Attempt to Access Sensitive Key/Config File (LOG ONLY)',\
    tag:'OWASP_TOP_10/A04',\
    setvar:'tx.anomaly_score_pl1=+%{tx.critical_anomaly_score}'"



#
# [4] A04 Cryptographic Failures - Private Key Leakage - LOG ONLY
# 응답 본문에 Private Key 노출 패턴 탐지 후 로그만
#
SecRule RESPONSE_BODY "@rx -----BEGIN [A-Z]+ PRIVATE KEY-----" \
    "id:990004,\
    phase:4,\
    t:none,\
    pass,\
    log,\
    msg:'Cryptographic Failures: Private Key Leakage Detected (LOG ONLY)',\
    tag:'OWASP_TOP_10/A04',\
    setvar:'tx.anomaly_score_pl1=+%{tx.critical_anomaly_score}'"



#
# [5] A04 Cryptographic Failures - Cleartext Password Pattern Leakage - LOG ONLY
# 응답 본문 내 평문 패스워드 패턴 탐지 후 로그만
#
SecRule RESPONSE_BODY "@rx (?i)(?:\"|')(?:password|passwd|pwd|secret)(?:\"|')\s*[:=]\s*(?:\"|')[^\"']{3,}(?:\"|')" \
    "id:990005,\
    phase:4,\
    t:none,\
    pass,\
    log,\
    msg:'Cryptographic Failures: Potential Cleartext Password Leakage (LOG ONLY)',\
    tag:'OWASP_TOP_10/A04',\
    setvar:'tx.anomaly_score_pl1=+%{tx.critical_anomaly_score}'"



#
# [6] Brute Force Attack Detection - Rate Limiting for Login Attempts - LOG ONLY
# 동일 IP에서 30초 내 10회 초과 로그인 시도 시 탐지 후 로그만
#

# 로그인 관련 파라미터 포함 POST 요청 매칭 (탐지 룰)
SecRule REQUEST_METHOD "POST" \
    "chain, \
    id:990006, \
    phase:2, \
    t:none, \
    pass, \
    log, \
    msg:'Brute Force Attack Detected Pattern - Login Parameters in POST (LOG ONLY)', \
    tag:'OWASP_TOP_10/A07'"
SecRule ARGS_NAMES|ARGS "@pm username password passwd user login" \
    "t:none"

# IP별 카운터 증가
SecAction \
    "id:990007, \
    phase:1, \
    nolog, \
    pass, \
    initcol:ip=%{REMOTE_ADDR}, \
    setvar:ip.bruteforce_count=+1, \
    expirevar:ip.bruteforce_count=30"

# 카운터 > 10 일 때 탐지 후 로그만
SecRule IP:BRUTEFORCE_COUNT "@gt 10" \
    "id:990008, \
    phase:1, \
    pass, \
    log, \
    msg:'Brute Force Attack Detected - Too Many Login Attempts from IP (LOG ONLY)', \
    tag:'OWASP_TOP_10/A07'"

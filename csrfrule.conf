# 1. CSRF 탐지 규칙 1: POST 요청에 Referer 헤더 누락 또는 비정상 도메인 (WARNING: +3점)
SecRule REQUEST_METHOD "@streq POST" \
  "id:1000101,\
  phase:2,\
  pass,\
  t:none,\
  setvar:tx.inbound_anomaly_score=+3,\
  setvar:tx.warning_anomaly_score=+3,\
  msg:'CSRF Detection: Missing or invalid Referer on POST',\
  logdata:'Referer: %{REQUEST_HEADERS.referer}',\
  tag:'application-multi',\
  tag:'language-multi',\
  tag:'platform-multi',\
  tag:'attack-csrf',\
  severity:'WARNING'"

SecRule REQUEST_HEADERS:Referer "!@beginsWith https://yourdomain.com" \
  "chain,t:none"

# 2. CSRF 탐지 규칙 2: Origin 헤더 불일치 또는 누락 (ERROR: +4점)
SecRule REQUEST_METHOD "@rx (POST|PUT|DELETE)" \
  "id:1000102,\
  phase:2,\
  pass,\
  t:none,\
  setvar:tx.inbound_anomaly_score=+4,\
  setvar:tx.error_anomaly_score=+4,\
  msg:'CSRF Detection: Invalid or missing Origin header',\
  logdata:'Origin: %{REQUEST_HEADERS.origin}',\
  tag:'attack-csrf',\
  severity:'ERROR'"

SecRule REQUEST_HEADERS:Origin "!@beginsWith https://yourdomain.com" \
  "chain,t:none"

# 3. CSRF 탐지 규칙 3: CSRF 토큰 파라미터 누락 (NOTICE: +2점, 앱에서 토큰 사용 시)
SecRule REQUEST_METHOD "@streq POST" \
  "id:1000103,\
  phase:2,\
  pass,\
  t:none,\
  setvar:tx.inbound_anomaly_score=+2,\
  setvar:tx.notice_anomaly_score=+2,\
  msg:'CSRF Detection: Missing CSRF token parameter',\
  tag:'attack-csrf',\
  severity:'NOTICE'"

SecRule ARGS_NAMES "!@contains csrf_token" \
  "chain" \
SecRule ARGS_NAMES "!@contains _token" \
  "chain" \
SecRule ARGS_NAMES "!@contains __RequestVerificationToken" 

# 4. Anomaly Score 임계값 설정 (누적 5점 이상 시 차단)
SecAction \
  "id:900110,\
  phase:2,\
  pass,\
  nolog,\
  setvar:tx.inbound_anomaly_score_threshold=5"

# 5. 차단 규칙 (Inbound Anomaly Score 초과 시)
SecRule TX:INBOUND_ANOMALY_SCORE "@ge 5" \
  "id:949110,\
  phase:2,\
  deny,\
  status:403,\
  t:none,\
  block,\
  msg:'CSRF Attack Blocked: Inbound Anomaly Score Exceeded (Score: %{TX.INBOUND_ANOMALY_SCORE})',\
  logdata:'Matched CSRF rules: %{MATCHED_VAR}',\
  tag:'application-multi',\
  tag:'language-multi',\
  tag:'platform-multi',\
  tag:'attack-csrf',\
  severity:'CRITICAL'"
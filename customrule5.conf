# ------------------------------------------------------------------------
# Custom Security Rules for Enhanced Protection (BLOCK VERSION)
# ID Range: 990000 - 990010
# ------------------------------------------------------------------------


#
# [1] CSRF Protection (Missing Referer Header) - BLOCK
#
SecRule REQUEST_METHOD "POST" \
    "id:990001,\
    phase:2,\
    deny,\
    status:403,\
    t:none,\
    log,\
    msg:'CSRF Attack: Missing Referer Header (BLOCK)',\
    tag:'OWASP_TOP_10/A01',\
    chain"
    SecRule &REQUEST_HEADERS:Referer "@eq 0" "t:none"



#
# [2] Information Leakage - Error Messages (BLOCK)
#
SecRule RESPONSE_BODY "@rx (?i)(fatal error|sql syntax|ora-[0-9]+|microsoft ole db provider|stack trace|unclosed quotation mark|syntax error at|unexpected end of file)" \
    "id:990002,\
    phase:4,\
    deny,\
    status:403,\
    t:none,\
    log,\
    msg:'Information Leakage: Application Error Message (BLOCK)',\
    tag:'OWASP_TOP_10/A05',\
    setvar:'tx.anomaly_score_pl1=+%{tx.critical_anomaly_score}'"



#
# [3] Sensitive Key/Config File Access - BLOCK
#
SecRule REQUEST_FILENAME "@rx \.(?:pem|key|crt|env|p12|pfx|asc|jks)$" \
    "id:990003,\
    phase:2,\
    deny,\
    status:403,\
    t:none,t:lowercase,\
    log,\
    msg:'Cryptographic Failure: Sensitive Key/Config File Access Attempt (BLOCK)',\
    tag:'OWASP_TOP_10/A04',\
    setvar:'tx.anomaly_score_pl1=+%{tx.critical_anomaly_score}'"



#
# [4] Private Key Exposure Detection - BLOCK
#
SecRule RESPONSE_BODY "@rx -----BEGIN [A-Z]+ PRIVATE KEY-----" \
    "id:990004,\
    phase:4,\
    deny,\
    status:403,\
    t:none,\
    log,\
    msg:'Cryptographic Failure: Private Key Leakage Detected (BLOCK)',\
    tag:'OWASP_TOP_10/A04',\
    setvar:'tx.anomaly_score_pl1=+%{tx.critical_anomaly_score}'"



#
# [5] Cleartext Password Exposure - BLOCK
#
SecRule RESPONSE_BODY "@rx (?i)(?:\"|')(?:password|passwd|pwd|secret)(?:\"|')\s*[:=]\s*(?:\"|')[^\"']{3,}(?:\"|')" \
    "id:990005,\
    phase:4,\
    deny,\
    status:403,\
    t:none,\
    log,\
    msg:'Cryptographic Failure: Cleartext Password Exposure Detected (BLOCK)',\
    tag:'OWASP_TOP_10/A04',\
    setvar:'tx.anomaly_score_pl1=+%{tx.critical_anomaly_score}'"



#
# [6] Brute Force Login Pattern Detection - BLOCK
#
SecRule REQUEST_METHOD "POST" \
    "id:990006,\
    phase:2,\
    deny,\
    status:403,\
    t:none,\
    log,\
    msg:'Brute Force Detection: Login Parameters in POST (BLOCK)',\
    tag:'OWASP_TOP_10/A07',\
    chain"
    SecRule ARGS_NAMES|ARGS "@pm username password passwd user login" "t:none"



#
# [7] Brute Force Counter Increase (ONLY on Login POST)
# (이 부분은 카운트만 올리는 용도 → deny 없음)
#
SecRule REQUEST_METHOD "POST" \
    "id:990007,\
    phase:2,\
    pass,\
    t:none,\
    nolog,\
    chain"
    SecRule ARGS_NAMES|ARGS "@pm username password passwd user login" \
        "t:none,\
        initcol:ip=%{REMOTE_ADDR},\
        setvar:ip.bruteforce_count=+1,\
        expirevar:ip.bruteforce_count=30"



#
# [8] Brute Force Threshold - BLOCK (20회 초과 시 차단)
#
SecRule IP:BRUTEFORCE_COUNT "@gt 20" \
    "id:990008,\
    phase:2,\
    deny,\
    status:403,\
    t:none,\
    log,\
    msg:'Brute Force Detection: Excessive Login Attempts from IP (BLOCK)',\
    tag:'OWASP_TOP_10/A07'"


SecRule RESPONSE_BODY "@contains ORA-00933" \
    "id:990009,\
    phase:4,\
    deny,\
    status:403,\
    msg:'Server Misconfiguration Detection: Oracle SQL Error Detected (BLOCK)',\
    tag:'OWASP_TOP_10/A10'"
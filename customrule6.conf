# ------------------------------------------------------------------------
# Custom Security Rules for Enhanced Protection (FINAL VERSION)
# ------------------------------------------------------------------------

#
# [0] SET EXPECTED ORDER ID - PASS (선행 규칙)
# (사용자가 신뢰할 수 있는 페이지(/stu/myOrderList.do)를 거쳐갈 때 유효한 order_no를 세션에 저장해야 합니다.)
#
SecRule REQUEST_URI "@contains /stu/myOrderList.do" \
    "id:990000,\
    phase:4,\
    pass,\
    t:none,\
    nolog,\
    chain"
    # 이 규칙은 사용자 애플리케이션의 응답 본문에서 order_no를 추출하는 복잡한 로직이 와야 합니다.
    # 예시: 'order_no=' 다음의 숫자를 추출하여 세션에 저장.
    # SecRule RESPONSE_BODY "@rx order_no=(\d+)" "setvar:session.expected_order_id=%{TX.0}"

#
# [1] CSRF Protection (Missing Referer Header) - BLOCK
#
SecRule REQUEST_METHOD "POST" \
    "id:990001,\
    phase:2,\
    deny,\
    status:403,\
    t:none,\
    log,\
    msg:'CSRF Attack: Missing Referer Header (BLOCK)',\
    tag:'OWASP_TOP_10/A01',\
    chain"
    SecRule &REQUEST_HEADERS:Referer "@eq 0" "t:none"

#
# [2] Information Leakage - Error Messages - BLOCK
#
SecRule RESPONSE_BODY "@rx (?i)(fatal error|sql syntax|ora-[0-9]+|microsoft ole db provider|stack trace|unclosed quotation mark|syntax error at|unexpected end of file)" \
    "id:990002,\
    phase:4,\
    deny,\
    status:403,\
    t:none,\
    log,\
    msg:'Information Leakage: Application Error Message (BLOCK)',\
    tag:'OWASP_TOP_10/A05',\
    setvar:'tx.anomaly_score_pl1=+%{tx.critical_anomaly_score}'"

#
# [3] Sensitive Key/Config File Access - BLOCK
#
SecRule REQUEST_FILENAME "@rx \.(?:pem|key|crt|env|p12|pfx|asc|jks)$" \
    "id:990003,\
    phase:2,\
    deny,\
    status:403,\
    t:none,t:lowercase,\
    log,\
    msg:'Cryptographic Failure: Sensitive Key/Config File Access Attempt (BLOCK)',\
    tag:'OWASP_TOP_10/A04',\
    setvar:'tx.anomaly_score_pl1=+%{tx.critical_anomaly_score}'"

#
# [4] Private Key Exposure Detection - BLOCK
#
SecRule RESPONSE_BODY "@rx -----BEGIN [A-Z]+ PRIVATE KEY-----" \
    "id:990004,\
    phase:4,\
    deny,\
    status:403,\
    t:none,\
    log,\
    msg:'Cryptographic Failure: Private Key Leakage Detected (BLOCK)',\
    tag:'OWASP_TOP_10/A04',\
    setvar:'tx.anomaly_score_pl1=+%{tx.critical_anomaly_score}'"

#
# [5] Cleartext Password Exposure - BLOCK
#
SecRule RESPONSE_BODY "@rx (?i)(?:\"|')(?:password|passwd|pwd|secret)(?:\"|')\s*[:=]\s*(?:\"|')[^\"']{3,}(?:\"|')" \
    "id:990005,\
    phase:4,\
    deny,\
    status:403,\
    t:none,\
    log,\
    msg:'Cryptographic Failure: Cleartext Password Exposure Detected (BLOCK)',\
    tag:'OWASP_TOP_10/A04',\
    setvar:'tx.anomaly_score_pl1=+%{tx.critical_anomaly_score}'"

#
# [6] Brute Force Login Pattern Detection - LOG ONLY
#
SecRule REQUEST_METHOD "POST" \
    "id:990006,\
    phase:2,\
    pass,\
    status:403,\
    t:none,\
    log,\
    msg:'Brute Force Detection: Login Parameters in POST (LOG ONLY)',\
    tag:'OWASP_TOP_10/A07',\
    chain"
    SecRule ARGS_NAMES|ARGS "@pm username password passwd user login" "t:none"

#
# [7] Brute Force Counter Increase (ONLY on Login POST)
#
SecRule REQUEST_METHOD "POST" \
    "id:990007,\
    phase:2,\
    pass,\
    t:none,\
    nolog,\
    chain"
    SecRule ARGS_NAMES|ARGS "@pm username password passwd user login" \
        "t:none,\
        initcol:ip=%{REMOTE_ADDR},\
        setvar:ip.bruteforce_count=+1,\
        expirevar:ip.bruteforce_count=30"

#
# [8] Brute Force Threshold - LOG ONLY
#
SecRule IP:BRUTEFORCE_COUNT "@gt 20" \
    "id:990008,\
    phase:2,\
    pass,\
    status:403,\
    t:none,\
    log,\
    msg:'Brute Force Detection: Excessive Login Attempts from IP (LOG ONLY)',\
    tag:'OWASP_TOP_10/A07'"

#
# [9] Server Misconfiguration Detection: Oracle SQL Error - BLOCK
#
SecRule RESPONSE_BODY "@contains ORA-00933" \
    "id:990009,\
    phase:4,\
    log,\
    deny,\
    status:403,\
    msg:'Server Misconfiguration Detection: Oracle SQL Error Detected (BLOCK)',\
    tag:'OWASP_TOP_10/A05'"

#
# [10] Parameter Tampering Detection: order_no Format Validation - BLOCK
# (order_no에 숫자 이외의 값이 들어올 경우 차단)
#
SecRule ARGS:order_no "!@rx ^[0-9]+$" \
    "id:990010,\
    phase:2,\
    deny,\
    status:403,\
    t:none,\
    log,\
    msg:'Parameter Tampering: Non-numeric or Empty Order Number Detected (BLOCK)',\
    tag:'OWASP_TOP_10/A01',\
    setvar:'tx.anomaly_score_pl1=+%{tx.critical_anomaly_score}'"

#
# [11] Parameter Tampering Detection: Order Number Mismatch - BLOCK
# (요청된 order_no가 Rule 990000에서 저장한 예상 값과 다르면 차단)
#
SecRule ARGS:order_no "@ne %{session.expected_order_id}" \
    "id:990011,\
    phase:2,\
    deny,\
    status:403,\
    t:none,\
    log,\
    msg:'Parameter Tampering: Order Number Mismatch (BLOCK)',\
    tag:'OWASP_TOP_10/A01',\
    chain"
    SecRule REQUEST_URI "@contains /stu/my_detail.do" "t:none"
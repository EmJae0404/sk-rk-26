# --- CSRF (Cross-Site Request Forgery) 방어: A06/A01 관련 ---
# Rule ID: 99991001 - CSRF 방어: Referer 헤더 검사
SecRule REQUEST_METHOD "@streq POST" "id:99991001,phase:2,chain,block,\
  msg:'OWASP 2025 A06 Insecure Design/A01 Access Control: CSRF Attempt - Invalid Referer',\
  severity:'CRITICAL',\
  tag:'WEB_ATTACK/CSRF',\
  tag:'OWASP_2025/A06/A01'"
  SecRule &REQUEST_HEADERS:Referer "@eq 0" "chain"
    SecRule REQUEST_HEADERS:Referer "!@contains %{REQUEST_HEADERS:Host}"

# Rule ID: 99991002 - CSRF 방어: GET 요청에서 민감한 행위 차단
SecRule ARGS "@rx (delete|update|add|change|remove)Id" \
  "id:99991002,\
  phase:2,\
  block,\
  msg:'OWASP 2025 A06 Insecure Design: Sensitive Action in GET Request - CSRF Possibility',\
  severity:'WARNING',\
  tag:'WEB_ATTACK/CSRF',\
  tag:'OWASP_2025/A06'"


# --- A04:2025 Cryptographic Failures (암호화 실패) 탐지 ---
# Rule ID: 99992001 - 민감 정보 평문 노출 탐지 (응답 헤더)
SecRule RESPONSE_HEADERS "@rx (password|secret|apikey)" \
  "id:99992001,\
  phase:4,\
  deny,\
  msg:'OWASP 2025 A04 Cryptographic Failures: Sensitive Data Exposure in Response Header',\
  severity:'ERROR',\
  tag:'DATA_LEAKAGE/CRYPTO_FAILURE',\
  tag:'OWASP_2025/A04'"

# Rule ID: 99992002 - HTTP 기본 인증 정보(Base64) 평문 노출 탐지 (Non-HTTPS)
SecRule REQUEST_HEADERS:Authorization "@rx ^Basic\s+(.*)$" \
  "id:99992002,\
  phase:1,\
  t:none,chain,\
  msg:'OWASP 2025 A04 Cryptographic Failures: HTTP Basic Auth over non-HTTPS (Risk)',\
  severity:'CRITICAL',\
  tag:'WEB_ATTACK/CRYPTO_FAILURE',\
  tag:'OWASP_2025/A04'"
    SecRule REQUEST_PROTOCOL "@streq HTTP"


# --- A07:2025 Authentication Failures (인증 실패) 탐지 ---
# Rule ID: 99993001 - 인증 실패: 무차별 대입 공격 탐지 (로그인 페이지)
SecRule REQUEST_URI "@streq /login.do" \
  "id:99993001,\
  phase:2,\
  chain,\
  t:none,\
  nolog,\
  pass"
    SecRule REMOTE_ADDR "@rbl_limit 5/60" \
      "setvar:ip.login_fail_count=+1,\
      expirevar:ip.login_fail_count=60,\
      setvar:session.login_fail_count=+1,\
      setvar:ip.brute_force_attack=1,\
      block,\
      msg:'OWASP 2025 A07 Authentication Failures: Brute Force Attack Detected',\
      severity:'CRITICAL',\
      tag:'ATTACK/BRUTE_FORCE',\
      tag:'OWASP_2025/A07'"

# Rule ID: 99993002 - 인증 실패: 비정상적인 세션 토큰 사용 패턴 탐지
SecRule REQUEST_COOKIES:SESSIONID|REQUEST_COOKIES:PHPSESSID "@rx [A-Za-z0-9]{120,}" \
  "id:99993002,\
  phase:1,\
  block,\
  msg:'OWASP 2025 A07 Authentication Failures: Suspiciously Long Session Token',\
  severity:'WARNING',\
  tag:'ATTACK/SESSION_MANAGEMENT',\
  tag:'OWASP_2025/A07'"


# --- A10:2025 Mishandling of Exceptional Conditions (예외 처리 오류) 방어 ---
# Rule ID: 99994001 - 예외 처리 오류: 상세 서버 오류 메시지 노출 차단
SecRule RESPONSE_BODY "@rx (stack\strace|SQLSTATE|JDBC|Hibernate|Warning:\s+(require|include))" \
  "id:99994001,\
  phase:4,\
  block,\
  setenv:detail_error_detected,\
  msg:'OWASP 2025 A10 Exceptional Conditions Failure: Detailed Technical Error Exposed',\
  severity:'HIGH',\
  tag:'INFO_LEAKAGE/ERROR_MISHANDLING',\
  tag:'OWASP_2025/A10'"

# Rule ID: 99994002 - 404/500 응답 시 상세 오류 메시지 숨김
SecRule RESPONSE_STATUS "@streq 404|@streq 500" \
  "id:99994002,\
  phase:4,chain,\
  pass,\
  setenv:detail_error_detected"
    SecRule &TX:detail_error_detected "@eq 1" \
      "log,\
      setrsc:<html><body><h1>An internal error occurred.</h1></body></html>"
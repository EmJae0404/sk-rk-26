# ------------------------------------------------------------------------
# Custom Security Rules for Enhanced Protection (FINAL VERSION)
# ------------------------------------------------------------------------

# 
# [0] SET EXPECTED ORDER ID - PASS (선행 규칙 - 수정됨)
# 설명: /stu/myOrderList.do 응답(HTML)에서 order_no를 추출하여 세션에 저장 (WAF가 유효한 번호를 학습)
#
SecRule REQUEST_URI "@contains /stu/myOrderList.do" \
    "id:990000,\
    phase:4,\
    pass,\
    t:none,\
    nolog,\
    chain"
    SecRule RESPONSE_BODY "@rx order_no=([0-9]+)" \
        "t:none,\
        capture,\
        setsid:%{REMOTE_ADDR},\
        setvar:session.expected_order_id=%{tx.1}" # tx.1에 캡처된 숫자 저장

---

#
# [1] CSRF Protection (Missing Referer Header) - BLOCK
#
SecRule REQUEST_METHOD "POST" \
    "id:990001,\
    phase:2,\
    deny,\
    status:403,\
    t:none,\
    log,\
    msg:'CSRF Attack: Missing Referer Header (BLOCK)',\
    tag:'OWASP_TOP_10/A01',\
    chain"
    SecRule &REQUEST_HEADERS:Referer "@eq 0" "t:none"

#
# [2] Information Leakage - Error Messages - BLOCK
#
SecRule RESPONSE_BODY "@rx (?i)(fatal error|sql syntax|ora-[0-9]+|microsoft ole db provider|stack trace|unclosed quotation mark|syntax error at|unexpected end of file)" \
    "id:990002,\
    phase:4,\
    deny,\
    status:403,\
    t:none,\
    log,\
    msg:'Information Leakage: Application Error Message (BLOCK)',\
    tag:'OWASP_TOP_10/A05',\
    setvar:'tx.anomaly_score_pl1=+%{tx.critical_anomaly_score}'"

#
# [3] Sensitive Key/Config File Access - BLOCK
#
SecRule REQUEST_FILENAME "@rx \.(?:pem|key|crt|env|p12|pfx|asc|jks)$" \
    "id:990003,\
    phase:2,\
    deny,\
    status:403,\
    t:none,t:lowercase,\
    log,\
    msg:'Cryptographic Failure: Sensitive Key/Config File Access Attempt (BLOCK)',\
    tag:'OWASP_TOP_10/A04',\
    setvar:'tx.anomaly_score_pl1=+%{tx.critical_anomaly_score}'"

#
# [4] Private Key Exposure Detection - BLOCK
#
SecRule RESPONSE_BODY "@rx -----BEGIN [A-Z]+ PRIVATE KEY-----" \
    "id:990004,\
    phase:4,\
    deny,\
    status:403,\
    t:none,\
    log,\
    msg:'Cryptographic Failure: Private Key Leakage Detected (BLOCK)',\
    tag:'OWASP_TOP_10/A04',\
    setvar:'tx.anomaly_score_pl1=+%{tx.critical_anomaly_score}'"

#
# [5] Cleartext Password Exposure - BLOCK
#
SecRule RESPONSE_BODY "@rx (?i)(?:\"|')(?:password|passwd|pwd|secret)(?:\"|')\s*[:=]\s*(?:\"|')[^\"']{3,}(?:\"|')" \
    "id:990005,\
    phase:4,\
    deny,\
    status:403,\
    t:none,\
    log,\
    msg:'Cryptographic Failure: Cleartext Password Exposure Detected (BLOCK)',\
    tag:'OWASP_TOP_10/A04',\
    setvar:'tx.anomaly_score_pl1=+%{tx.critical_anomaly_score}'"

#
# [6] Brute Force Login Pattern Detection - LOG ONLY
#
SecRule REQUEST_METHOD "POST" \
    "id:990006,\
    phase:2,\
    pass,\
    status:403,\
    t:none,\
    log,\
    msg:'Brute Force Detection: Login Parameters in POST (LOG ONLY)',\
    tag:'OWASP_TOP_10/A07',\
    chain"
    SecRule ARGS_NAMES|ARGS "@pm username password passwd user login" "t:none"

#
# [7] Brute Force Counter Increase (ONLY on Login POST)
#
SecRule REQUEST_METHOD "POST" \
    "id:990007,\
    phase:2,\
    pass,\
    t:none,\
    nolog,\
    chain"
    SecRule ARGS_NAMES|ARGS "@pm username password passwd user login" \
        "t:none,\
        initcol:ip=%{REMOTE_ADDR},\
        setvar:ip.bruteforce_count=+1,\
        expirevar:ip.bruteforce_count=30"

#
# [8] Brute Force Threshold - LOG ONLY
#
SecRule IP:BRUTEFORCE_COUNT "@gt 20" \
    "id:990008,\
    phase:2,\
    pass,\
    status:403,\
    t:none,\
    log,\
    msg:'Brute Force Detection: Excessive Login Attempts from IP (LOG ONLY)',\
    tag:'OWASP_TOP_10/A07'"

#
# [9] Server Misconfiguration Detection: Oracle SQL Error - BLOCK
#
SecRule RESPONSE_BODY "@contains ORA-00933" \
    "id:990009,\
    phase:4,\
    log,\
    deny,\
    status:403,\
    msg:'Server Misconfiguration Detection: Oracle SQL Error Detected (BLOCK)',\
    tag:'OWASP_TOP_10/A05'"

#
# [10] Parameter Tampering Detection: order_no Format Validation - BLOCK
# 설명: ARGS:order_no가 숫자가 아니거나 아예 없는 경우 차단
#
SecRule ARGS:order_no "!@rx ^[0-9]+$" \
    "id:990010,\
    phase:2,\
    deny,\
    status:403,\
    t:none,\
    log,\
    msg:'Parameter Tampering: Non-numeric or Empty Order Number Detected (BLOCK)',\
    tag:'OWASP_TOP_10/A01',\
    setvar:'tx.anomaly_score_pl1=+%{tx.critical_anomaly_score}'"

#
# [11] Parameter Tampering Detection: Order Number Mismatch - BLOCK (수정됨)
# 설명: 요청 URI가 /my_detail.do이고, 세션 변수가 존재하며, ARGS:order_no가 세션 값과 다를 때 차단
#
SecRule REQUEST_URI "@contains /stu/my_detail.do" \
    "id:990011,\
    phase:2,\
    deny,\
    status:403,\
    t:none,\
    log,\
    msg:'Parameter Tampering: Order Number Mismatch (BLOCK)',\
    tag:'OWASP_TOP_10/A01',\
    chain"
    SecRule &SESSION:expected_order_id "!@eq 0" \
        "t:none,\
        chain"
        SecRule ARGS:order_no "!@streq %{session.expected_order_id}" \
            "t:none"
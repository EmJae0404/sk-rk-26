# ------------------------------------------------------------------------
# Custom Security Rules for Enhanced Protection (LOG ONLY VERSION)
# ID Range: 990000 - 990010
# ------------------------------------------------------------------------


#
# [1] CSRF Protection (Missing Referer Header) - LOG ONLY
# POST 요청에서 Referer 헤더가 없는 경우 탐지
#
SecRule REQUEST_METHOD "POST" \
    "id:990001,\
    phase:2,\
    pass,\
    t:none,\
    log,\
    msg:'CSRF Attack: Missing Referer Header (LOG ONLY)',\
    tag:'OWASP_TOP_10/A01',\
    chain"
    SecRule &REQUEST_HEADERS:Referer "@eq 0" "t:none"



#
# [2] Information Leakage - Error Messages (LOG ONLY)
# 응답 본문에서 에러/예외 메시지 패턴 탐지
#
SecRule RESPONSE_BODY "@rx (?i)(fatal error|sql syntax|ora-[0-9]+|microsoft ole db provider|stack trace|unclosed quotation mark|syntax error at|unexpected end of file)" \
    "id:990002,\
    phase:4,\
    pass,\
    t:none,\
    log,\
    msg:'Information Leakage: Application Error Message (LOG ONLY)',\
    tag:'OWASP_TOP_10/A05',\
    setvar:'tx.anomaly_score_pl1=+%{tx.critical_anomaly_score}'"



#
# [3] Sensitive Key/Config File Access - LOG ONLY
# 민감한 암호/환경 설정 파일 접근 시도 탐지
#
SecRule REQUEST_FILENAME "@rx \.(?:pem|key|crt|env|p12|pfx|asc|jks)$" \
    "id:990003,\
    phase:2,\
    pass,\
    t:none,t:lowercase,\
    log,\
    msg:'Cryptographic Failure: Sensitive Key/Config File Access Attempt (LOG ONLY)',\
    tag:'OWASP_TOP_10/A04',\
    setvar:'tx.anomaly_score_pl1=+%{tx.critical_anomaly_score}'"



#
# [4] Private Key Exposure Detection - LOG ONLY
# 응답 본문에 Private Key 노출 패턴 탐지
#
SecRule RESPONSE_BODY "@rx -----BEGIN [A-Z]+ PRIVATE KEY-----" \
    "id:990004,\
    phase:4,\
    pass,\
    t:none,\
    log,\
    msg:'Cryptographic Failure: Private Key Leakage Detected (LOG ONLY)',\
    tag:'OWASP_TOP_10/A04',\
    setvar:'tx.anomaly_score_pl1=+%{tx.critical_anomaly_score}'"



#
# [5] Cleartext Password Exposure Detection - LOG ONLY
# 응답 본문에 패스워드 패턴 평문 노출 탐지
#
SecRule RESPONSE_BODY "@rx (?i)(?:\"|')(?:password|passwd|pwd|secret)(?:\"|')\s*[:=]\s*(?:\"|')[^\"']{3,}(?:\"|')" \
    "id:990005,\
    phase:4,\
    pass,\
    t:none,\
    log,\
    msg:'Cryptographic Failure: Cleartext Password Exposure Detected (LOG ONLY)',\
    tag:'OWASP_TOP_10/A04',\
    setvar:'tx.anomaly_score_pl1=+%{tx.critical_anomaly_score}'"



#
# [6] Brute Force Login Pattern Detection - LOG ONLY
# 로그인 시도로 보이는 POST 요청 탐지
#
SecRule REQUEST_METHOD "POST" \
    "id:990006,\
    phase:2,\
    pass,\
    t:none,\
    log,\
    msg:'Brute Force Detection: Login Parameters in POST (LOG ONLY)',\
    tag:'OWASP_TOP_10/A07',\
    chain"
    SecRule ARGS_NAMES|ARGS "@pm username password passwd user login" "t:none"



#
# [7] Brute Force Counter Increase (ONLY on Login POST)
# 로그인 파라미터가 포함된 POST 요청일 때만 IP 카운터 증가
#
SecRule REQUEST_METHOD "POST" \
    "id:990007,\
    phase:2,\
    pass,\
    t:none,\
    nolog,\
    chain"
    SecRule ARGS_NAMES|ARGS "@pm username password passwd user login" \
        "t:none,\
        initcol:ip=%{REMOTE_ADDR},\
        setvar:ip.bruteforce_count=+1,\
        expirevar:ip.bruteforce_count=30"



#
# [8] Brute Force Threshold (LOG ONLY)
# 30초 내 login 시도 10회 초과 시 탐지 (차단 X)
#
SecRule IP:BRUTEFORCE_COUNT "@gt 10" \
    "id:990008,\
    phase:2,\
    pass,\
    t:none,\
    log,\
    msg:'Brute Force Detection: Excessive Login Attempts from IP (LOG ONLY)',\
    tag:'OWASP_TOP_10/A07'"

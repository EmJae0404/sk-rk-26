# ========================================
# ModSecurity Rules - OWASP 2025 Top 10
# 개선 및 최적화 버전
# ========================================

# --- 1. A06/A01: CSRF 방어 ---

# CSRF: Referer 헤더 누락 차단
SecRule REQUEST_METHOD '@rx ^(POST|PUT|DELETE|PATCH)

# CSRF: Referer 도메인 불일치 차단
SecRule REQUEST_METHOD '@rx ^(POST|PUT|DELETE|PATCH)


# --- 2. A04: 암호화 실패 방어 ---

# 응답 헤더에서 민감 정보 노출 차단
SecRule RESPONSE_HEADERS '@rx (?i)(password|secret|apikey|api[_-]?key|token|credential)' \
  "id:99992001,\
  phase:4,\
  deny,\
  status:500,\
  msg:'OWASP 2025 A04: Sensitive Data in Response Header',\
  severity:'ERROR',\
  logdata:'Header: %{MATCHED_VAR_NAME}',\
  tag:'DATA_LEAKAGE/CRYPTO_FAILURE',\
  tag:'OWASP_2025/A04'"

# HTTP 기본 인증 평문 전송 경고 (Non-HTTPS)
SecRule TX:HTTPS '@eq 0' \
  "id:99992002,\
  phase:1,\
  chain,\
  t:none,\
  msg:'OWASP 2025 A04: Basic Auth over Insecure HTTP',\
  severity:'CRITICAL',\
  logdata:'Auth Header: %{REQUEST_HEADERS.Authorization}',\
  tag:'WEB_ATTACK/CRYPTO_FAILURE',\
  tag:'OWASP_2025/A04'"
    SecRule REQUEST_HEADERS:Authorization '@rx ^Basic\s+' \
      "block,\
      status:426"

# URL 파라미터에 민감 정보 포함 차단
SecRule ARGS_NAMES '@rx (?i)^(password|pwd|passwd|secret|api[_-]?key|token|credit[_-]?card)


# --- 3. A07: 인증 실패 방어 ---

# 로그인 시도 카운팅
SecRule REQUEST_URI '@rx (?i)/(login|signin|authenticate)' \
  "id:99993001,\
  phase:2,\
  t:none,\
  pass,\
  nolog,\
  setvar:'ip.login_attempt=+1',\
  expirevar:'ip.login_attempt=60'"

# Brute Force 공격 차단 (5회/분)
SecRule IP:login_attempt '@gt 5' \
  "id:99993002,\
  phase:2,\
  deny,\
  status:429,\
  msg:'OWASP 2025 A07: Brute Force Attack Detected',\
  severity:'CRITICAL',\
  logdata:'IP: %{REMOTE_ADDR}, Attempts: %{IP.login_attempt}',\
  tag:'ATTACK/BRUTE_FORCE',\
  tag:'OWASP_2025/A07',\
  setvar:'ip.blocked=1',\
  expirevar:'ip.blocked=300'"

# 의심스러운 긴 세션 토큰 차단
SecRule REQUEST_COOKIES '@rx [A-Za-z0-9]{150,}' \
  "id:99993003,\
  phase:1,\
  block,\
  status:400,\
  msg:'OWASP 2025 A07: Abnormally Long Session Token',\
  severity:'WARNING',\
  logdata:'Cookie Length: %{MATCHED_VAR}',\
  tag:'ATTACK/SESSION_MANAGEMENT',\
  tag:'OWASP_2025/A07'"

# 세션 고정 공격 패턴 탐지
SecRule ARGS:SESSIONID|ARGS:PHPSESSID|ARGS:JSESSIONID '@rx .' \
  "id:99993004,\
  phase:2,\
  block,\
  status:400,\
  msg:'OWASP 2025 A07: Session Fixation Attempt',\
  severity:'HIGH',\
  logdata:'Session ID in URL: %{MATCHED_VAR}',\
  tag:'ATTACK/SESSION_FIXATION',\
  tag:'OWASP_2025/A07'"


# --- 4. A10: 예외 처리 오류 방어 ---

# 상세 기술 오류 메시지 노출 차단
SecRule RESPONSE_BODY '@rx (?i)(stack\s+trace|SQLSTATE|SQLException|ORA-[0-9]{5}|MySQL.*Error|JDBC|Hibernate|Warning:\s+(require|include|fopen)|Fatal\s+error:|Parse\s+error:)' \
  "id:99994001,\
  phase:4,\
  pass,\
  log,\
  msg:'OWASP 2025 A10: Technical Error Details Exposed',\
  severity:'HIGH',\
  logdata:'Error Pattern: %{MATCHED_VAR}',\
  tag:'INFO_LEAKAGE/ERROR_MISHANDLING',\
  tag:'OWASP_2025/A10',\
  setenv:detail_error_detected=1"

# 민감 경로 정보 노출 차단
SecRule RESPONSE_BODY '@rx (?i)(\/var\/www|\/home\/[a-z0-9]+|C:\\\\(inetpub|xampp|wamp)|\/usr\/local)' \
  "id:99994002,\
  phase:4,\
  pass,\
  log,\
  msg:'OWASP 2025 A10: File Path Disclosure',\
  severity:'MEDIUM',\
  logdata:'Path Found: %{MATCHED_VAR}',\
  tag:'INFO_LEAKAGE/PATH_DISCLOSURE',\
  tag:'OWASP_2025/A10'"

# 서버 버전 정보 노출 차단
SecRule RESPONSE_HEADERS:Server '@rx (?i)(Apache/[0-9\.]+|nginx/[0-9\.]+|IIS/[0-9\.]+|PHP/[0-9\.]+)' \
  "id:99994003,\
  phase:4,\
  pass,\
  log,\
  msg:'OWASP 2025 A10: Server Version Disclosure',\
  severity:'LOW',\
  logdata:'Server Header: %{MATCHED_VAR}',\
  tag:'INFO_LEAKAGE/VERSION_DISCLOSURE',\
  tag:'OWASP_2025/A10',\
  ctl:responseHeadersAction=append,\
  setvar:'tx.server_header_found=1'"


# --- 5. 추가 보안 규칙 (A03: Injection 방어) ---

# SQL Injection 기본 패턴 차단
SecRule ARGS|REQUEST_BODY '@rx (?i)(\bunion\b.+\bselect\b|''\s*or\s*''?1''?\s*=\s*''?1|;\s*drop\s+table|<script|javascript:)' \
  "id:99995001,\
  phase:2,\
  block,\
  status:403,\
  msg:'OWASP 2025 A03: SQL Injection or XSS Attempt',\
  severity:'CRITICAL',\
  logdata:'Payload: %{MATCHED_VAR}',\
  tag:'WEB_ATTACK/SQL_INJECTION',\
  tag:'OWASP_2025/A03'"

# Command Injection 방어
SecRule ARGS|REQUEST_BODY '@rx (?i)(\||;|`|\$\(|&&|>\s*/|\.\./|/etc/passwd)' \
  "id:99995002,\
  phase:2,\
  block,\
  status:403,\
  msg:'OWASP 2025 A03: Command Injection Attempt',\
  severity:'CRITICAL',\
  logdata:'Payload: %{MATCHED_VAR}',\
  tag:'WEB_ATTACK/COMMAND_INJECTION',\
  tag:'OWASP_2025/A03'"


# --- 6. 모니터링 및 로깅 개선 ---

# 차단된 요청에 대한 상세 로깅
SecRule TX:ANOMALY_SCORE '@gt 0' \
  "id:99996001,\
  phase:5,\
  pass,\
  log,\
  msg:'Request Blocked - Anomaly Score: %{TX.ANOMALY_SCORE}',\
  logdata:'IP: %{REMOTE_ADDR}, URI: %{REQUEST_URI}, User-Agent: %{REQUEST_HEADERS.User-Agent}'"

# 보안 헤더 누락 경고 (응답)
SecRule &RESPONSE_HEADERS:X-Frame-Options '@eq 0' \
  "id:99996002,\
  phase:4,\
  pass,\
  log,\
  msg:'Security Header Missing: X-Frame-Options',\
  severity:'INFO',\
  tag:'SECURITY_HEADER/MISSING'"

SecRule &RESPONSE_HEADERS:X-Content-Type-Options '@eq 0' \
  "id:99996003,\
  phase:4,\
  pass,\
  log,\
  msg:'Security Header Missing: X-Content-Type-Options',\
  severity:'INFO',\
  tag:'SECURITY_HEADER/MISSING'" \
  "id:99991001,\
  phase:2,\
  chain,\
  t:none,\
  msg:'OWASP 2025 A06: CSRF - Missing Referer Header',\
  severity:'CRITICAL',\
  logdata:'Method: %{REQUEST_METHOD}, URI: %{REQUEST_URI}',\
  tag:'WEB_ATTACK/CSRF',\
  tag:'OWASP_2025/A06'"
    SecRule &REQUEST_HEADERS:Referer '@eq 0' \
      "block,\
      status:403"

# CSRF: Referer 도메인 불일치 차단
SecRule REQUEST_METHOD "@rx ^(POST|PUT|DELETE|PATCH)$" \
  "id:99991002,\
  phase:2,\
  chain,\
  t:none,\
  msg:'OWASP 2025 A06: CSRF - Referer Domain Mismatch',\
  severity:'CRITICAL',\
  logdata:'Referer: %{REQUEST_HEADERS.Referer}, Host: %{REQUEST_HEADERS.Host}',\
  tag:'WEB_ATTACK/CSRF',\
  tag:'OWASP_2025/A06'"
    SecRule &REQUEST_HEADERS:Referer "@gt 0" \
      "chain"
        SecRule REQUEST_HEADERS:Referer "!@contains %{REQUEST_HEADERS.Host}" \
          "block,\
          status:403"

# CSRF: GET 요청에서 민감 작업 차단
SecRule REQUEST_METHOD "@streq GET" \
  "id:99991003,\
  phase:2,\
  chain,\
  t:none,\
  msg:'OWASP 2025 A06: State-Changing Operation via GET',\
  severity:'WARNING',\
  tag:'WEB_ATTACK/CSRF',\
  tag:'OWASP_2025/A06'"
    SecRule REQUEST_URI "@rx (?i)(delete|remove|update|modify|add|create|change).*id=" \
      "block,\
      status:405"


# --- 2. A04: 암호화 실패 방어 ---

# 응답 헤더에서 민감 정보 노출 차단
SecRule RESPONSE_HEADERS "@rx (?i)(password|secret|apikey|api[_-]?key|token|credential)" \
  "id:99992001,\
  phase:4,\
  deny,\
  status:500,\
  msg:'OWASP 2025 A04: Sensitive Data in Response Header',\
  severity:'ERROR',\
  logdata:'Header: %{MATCHED_VAR_NAME}',\
  tag:'DATA_LEAKAGE/CRYPTO_FAILURE',\
  tag:'OWASP_2025/A04'"

# HTTP 기본 인증 평문 전송 경고 (Non-HTTPS)
SecRule TX:HTTPS "@eq 0" \
  "id:99992002,\
  phase:1,\
  chain,\
  t:none,\
  msg:'OWASP 2025 A04: Basic Auth over Insecure HTTP',\
  severity:'CRITICAL',\
  logdata:'Auth Header: %{REQUEST_HEADERS.Authorization}',\
  tag:'WEB_ATTACK/CRYPTO_FAILURE',\
  tag:'OWASP_2025/A04'"
    SecRule REQUEST_HEADERS:Authorization "@rx ^Basic\s+" \
      "block,\
      status:426"

# URL 파라미터에 민감 정보 포함 차단
SecRule ARGS_NAMES "@rx (?i)^(password|pwd|passwd|secret|api[_-]?key|token|credit[_-]?card)$" \
  "id:99992003,\
  phase:2,\
  block,\
  status:400,\
  msg:'OWASP 2025 A04: Sensitive Data in URL Parameters',\
  severity:'CRITICAL',\
  logdata:'Parameter: %{MATCHED_VAR_NAME}',\
  tag:'DATA_LEAKAGE/CRYPTO_FAILURE',\
  tag:'OWASP_2025/A04'"

# 민감 엔드포인트 HTTP 접근 차단
SecRule TX:HTTPS "@eq 0" \
  "id:99992004,\
  phase:1,\
  chain,\
  t:none,\
  msg:'OWASP 2025 A04: Insecure Access to Sensitive Endpoint',\
  severity:'HIGH',\
  tag:'CRYPTO_FAILURE',\
  tag:'OWASP_2025/A04'"
    SecRule REQUEST_URI "@rx ^/(login|admin|api|payment|checkout|account)" \
      "block,\
      status:426,\
      logdata:'URI: %{REQUEST_URI}'"


# --- 3. A07: 인증 실패 방어 ---

# 로그인 시도 카운팅
SecRule REQUEST_URI "@rx (?i)/(login|signin|authenticate)" \
  "id:99993001,\
  phase:2,\
  t:none,\
  pass,\
  nolog,\
  setvar:'ip.login_attempt=+1',\
  expirevar:'ip.login_attempt=60'"

# Brute Force 공격 차단 (5회/분)
SecRule IP:login_attempt "@gt 5" \
  "id:99993002,\
  phase:2,\
  deny,\
  status:429,\
  msg:'OWASP 2025 A07: Brute Force Attack Detected',\
  severity:'CRITICAL',\
  logdata:'IP: %{REMOTE_ADDR}, Attempts: %{IP.login_attempt}',\
  tag:'ATTACK/BRUTE_FORCE',\
  tag:'OWASP_2025/A07',\
  setvar:'ip.blocked=1',\
  expirevar:'ip.blocked=300'"

# 의심스러운 긴 세션 토큰 차단
SecRule REQUEST_COOKIES "@rx [A-Za-z0-9]{150,}" \
  "id:99993003,\
  phase:1,\
  block,\
  status:400,\
  msg:'OWASP 2025 A07: Abnormally Long Session Token',\
  severity:'WARNING',\
  logdata:'Cookie Length: %{MATCHED_VAR}',\
  tag:'ATTACK/SESSION_MANAGEMENT',\
  tag:'OWASP_2025/A07'"

# 세션 고정 공격 패턴 탐지
SecRule ARGS:SESSIONID|ARGS:PHPSESSID|ARGS:JSESSIONID "@rx ." \
  "id:99993004,\
  phase:2,\
  block,\
  status:400,\
  msg:'OWASP 2025 A07: Session Fixation Attempt',\
  severity:'HIGH',\
  logdata:'Session ID in URL: %{MATCHED_VAR}',\
  tag:'ATTACK/SESSION_FIXATION',\
  tag:'OWASP_2025/A07'"


# --- 4. A10: 예외 처리 오류 방어 ---

# 상세 기술 오류 메시지 노출 차단
SecRule RESPONSE_BODY "@rx (?i)(stack\s+trace|SQLSTATE|SQLException|ORA-[0-9]{5}|MySQL.*Error|JDBC|Hibernate|Warning:\s+(require|include|fopen)|Fatal\s+error:|Parse\s+error:)" \
  "id:99994001,\
  phase:4,\
  pass,\
  log,\
  msg:'OWASP 2025 A10: Technical Error Details Exposed',\
  severity:'HIGH',\
  logdata:'Error Pattern: %{MATCHED_VAR}',\
  tag:'INFO_LEAKAGE/ERROR_MISHANDLING',\
  tag:'OWASP_2025/A10',\
  setenv:detail_error_detected=1"

# 민감 경로 정보 노출 차단
SecRule RESPONSE_BODY "@rx (?i)(\/var\/www|\/home\/[a-z0-9]+|C:\\\\(inetpub|xampp|wamp)|\/usr\/local)" \
  "id:99994002,\
  phase:4,\
  pass,\
  log,\
  msg:'OWASP 2025 A10: File Path Disclosure',\
  severity:'MEDIUM',\
  logdata:'Path Found: %{MATCHED_VAR}',\
  tag:'INFO_LEAKAGE/PATH_DISCLOSURE',\
  tag:'OWASP_2025/A10'"

# 서버 버전 정보 노출 차단
SecRule RESPONSE_HEADERS:Server "@rx (?i)(Apache/[0-9\.]+|nginx/[0-9\.]+|IIS/[0-9\.]+|PHP/[0-9\.]+)" \
  "id:99994003,\
  phase:4,\
  pass,\
  log,\
  msg:'OWASP 2025 A10: Server Version Disclosure',\
  severity:'LOW',\
  logdata:'Server Header: %{MATCHED_VAR}',\
  tag:'INFO_LEAKAGE/VERSION_DISCLOSURE',\
  tag:'OWASP_2025/A10',\
  ctl:responseHeadersAction=append,\
  setvar:'tx.server_header_found=1'"


# --- 5. 추가 보안 규칙 (A03: Injection 방어) ---

# SQL Injection 기본 패턴 차단
SecRule ARGS|REQUEST_BODY "@rx (?i)(\bunion\b.+\bselect\b|'\s*or\s*'?1'?\s*=\s*'?1|;\s*drop\s+table|<script|javascript:)" \
  "id:99995001,\
  phase:2,\
  block,\
  status:403,\
  msg:'OWASP 2025 A03: SQL Injection or XSS Attempt',\
  severity:'CRITICAL',\
  logdata:'Payload: %{MATCHED_VAR}',\
  tag:'WEB_ATTACK/SQL_INJECTION',\
  tag:'OWASP_2025/A03'"

# Command Injection 방어
SecRule ARGS|REQUEST_BODY "@rx (?i)(\||;|`|\$\(|&&|>\s*/|\.\./|/etc/passwd)" \
  "id:99995002,\
  phase:2,\
  block,\
  status:403,\
  msg:'OWASP 2025 A03: Command Injection Attempt',\
  severity:'CRITICAL',\
  logdata:'Payload: %{MATCHED_VAR}',\
  tag:'WEB_ATTACK/COMMAND_INJECTION',\
  tag:'OWASP_2025/A03'"


# --- 6. 모니터링 및 로깅 개선 ---

# 차단된 요청에 대한 상세 로깅
SecRule TX:ANOMALY_SCORE "@gt 0" \
  "id:99996001,\
  phase:5,\
  pass,\
  log,\
  msg:'Request Blocked - Anomaly Score: %{TX.ANOMALY_SCORE}',\
  logdata:'IP: %{REMOTE_ADDR}, URI: %{REQUEST_URI}, User-Agent: %{REQUEST_HEADERS.User-Agent}'"

# 보안 헤더 누락 경고 (응답)
SecRule &RESPONSE_HEADERS:X-Frame-Options "@eq 0" \
  "id:99996002,\
  phase:4,\
  pass,\
  log,\
  msg:'Security Header Missing: X-Frame-Options',\
  severity:'INFO',\
  tag:'SECURITY_HEADER/MISSING'"

SecRule &RESPONSE_HEADERS:X-Content-Type-Options "@eq 0" \
  "id:99996003,\
  phase:4,\
  pass,\
  log,\
  msg:'Security Header Missing: X-Content-Type-Options',\
  severity:'INFO',\
  tag:'SECURITY_HEADER/MISSING'" \
  "id:99991002,\
  phase:2,\
  chain,\
  t:none,\
  msg:'OWASP 2025 A06: CSRF - Referer Domain Mismatch',\
  severity:'CRITICAL',\
  logdata:'Referer: %{REQUEST_HEADERS.Referer}, Host: %{REQUEST_HEADERS.Host}',\
  tag:'WEB_ATTACK/CSRF',\
  tag:'OWASP_2025/A06'"
    SecRule &REQUEST_HEADERS:Referer '@gt 0' \
      "chain"
        SecRule REQUEST_HEADERS:Referer '!@contains %{REQUEST_HEADERS.Host}' \
          "block,\
          status:403"

# CSRF: GET 요청에서 민감 작업 차단
SecRule REQUEST_METHOD '@streq GET' \
  "id:99991003,\
  phase:2,\
  chain,\
  t:none,\
  msg:'OWASP 2025 A06: State-Changing Operation via GET',\
  severity:'WARNING',\
  tag:'WEB_ATTACK/CSRF',\
  tag:'OWASP_2025/A06'"
    SecRule REQUEST_URI '@rx (?i)(delete|remove|update|modify|add|create|change).*id=' \
      "block,\
      status:405"


# --- 2. A04: 암호화 실패 방어 ---

# 응답 헤더에서 민감 정보 노출 차단
SecRule RESPONSE_HEADERS "@rx (?i)(password|secret|apikey|api[_-]?key|token|credential)" \
  "id:99992001,\
  phase:4,\
  deny,\
  status:500,\
  msg:'OWASP 2025 A04: Sensitive Data in Response Header',\
  severity:'ERROR',\
  logdata:'Header: %{MATCHED_VAR_NAME}',\
  tag:'DATA_LEAKAGE/CRYPTO_FAILURE',\
  tag:'OWASP_2025/A04'"

# HTTP 기본 인증 평문 전송 경고 (Non-HTTPS)
SecRule TX:HTTPS "@eq 0" \
  "id:99992002,\
  phase:1,\
  chain,\
  t:none,\
  msg:'OWASP 2025 A04: Basic Auth over Insecure HTTP',\
  severity:'CRITICAL',\
  logdata:'Auth Header: %{REQUEST_HEADERS.Authorization}',\
  tag:'WEB_ATTACK/CRYPTO_FAILURE',\
  tag:'OWASP_2025/A04'"
    SecRule REQUEST_HEADERS:Authorization "@rx ^Basic\s+" \
      "block,\
      status:426"

# URL 파라미터에 민감 정보 포함 차단
SecRule ARGS_NAMES "@rx (?i)^(password|pwd|passwd|secret|api[_-]?key|token|credit[_-]?card)$" \
  "id:99992003,\
  phase:2,\
  block,\
  status:400,\
  msg:'OWASP 2025 A04: Sensitive Data in URL Parameters',\
  severity:'CRITICAL',\
  logdata:'Parameter: %{MATCHED_VAR_NAME}',\
  tag:'DATA_LEAKAGE/CRYPTO_FAILURE',\
  tag:'OWASP_2025/A04'"

# 민감 엔드포인트 HTTP 접근 차단
SecRule TX:HTTPS "@eq 0" \
  "id:99992004,\
  phase:1,\
  chain,\
  t:none,\
  msg:'OWASP 2025 A04: Insecure Access to Sensitive Endpoint',\
  severity:'HIGH',\
  tag:'CRYPTO_FAILURE',\
  tag:'OWASP_2025/A04'"
    SecRule REQUEST_URI "@rx ^/(login|admin|api|payment|checkout|account)" \
      "block,\
      status:426,\
      logdata:'URI: %{REQUEST_URI}'"


# --- 3. A07: 인증 실패 방어 ---

# 로그인 시도 카운팅
SecRule REQUEST_URI "@rx (?i)/(login|signin|authenticate)" \
  "id:99993001,\
  phase:2,\
  t:none,\
  pass,\
  nolog,\
  setvar:'ip.login_attempt=+1',\
  expirevar:'ip.login_attempt=60'"

# Brute Force 공격 차단 (5회/분)
SecRule IP:login_attempt "@gt 5" \
  "id:99993002,\
  phase:2,\
  deny,\
  status:429,\
  msg:'OWASP 2025 A07: Brute Force Attack Detected',\
  severity:'CRITICAL',\
  logdata:'IP: %{REMOTE_ADDR}, Attempts: %{IP.login_attempt}',\
  tag:'ATTACK/BRUTE_FORCE',\
  tag:'OWASP_2025/A07',\
  setvar:'ip.blocked=1',\
  expirevar:'ip.blocked=300'"

# 의심스러운 긴 세션 토큰 차단
SecRule REQUEST_COOKIES "@rx [A-Za-z0-9]{150,}" \
  "id:99993003,\
  phase:1,\
  block,\
  status:400,\
  msg:'OWASP 2025 A07: Abnormally Long Session Token',\
  severity:'WARNING',\
  logdata:'Cookie Length: %{MATCHED_VAR}',\
  tag:'ATTACK/SESSION_MANAGEMENT',\
  tag:'OWASP_2025/A07'"

# 세션 고정 공격 패턴 탐지
SecRule ARGS:SESSIONID|ARGS:PHPSESSID|ARGS:JSESSIONID "@rx ." \
  "id:99993004,\
  phase:2,\
  block,\
  status:400,\
  msg:'OWASP 2025 A07: Session Fixation Attempt',\
  severity:'HIGH',\
  logdata:'Session ID in URL: %{MATCHED_VAR}',\
  tag:'ATTACK/SESSION_FIXATION',\
  tag:'OWASP_2025/A07'"


# --- 4. A10: 예외 처리 오류 방어 ---

# 상세 기술 오류 메시지 노출 차단
SecRule RESPONSE_BODY "@rx (?i)(stack\s+trace|SQLSTATE|SQLException|ORA-[0-9]{5}|MySQL.*Error|JDBC|Hibernate|Warning:\s+(require|include|fopen)|Fatal\s+error:|Parse\s+error:)" \
  "id:99994001,\
  phase:4,\
  pass,\
  log,\
  msg:'OWASP 2025 A10: Technical Error Details Exposed',\
  severity:'HIGH',\
  logdata:'Error Pattern: %{MATCHED_VAR}',\
  tag:'INFO_LEAKAGE/ERROR_MISHANDLING',\
  tag:'OWASP_2025/A10',\
  setenv:detail_error_detected=1"

# 민감 경로 정보 노출 차단
SecRule RESPONSE_BODY "@rx (?i)(\/var\/www|\/home\/[a-z0-9]+|C:\\\\(inetpub|xampp|wamp)|\/usr\/local)" \
  "id:99994002,\
  phase:4,\
  pass,\
  log,\
  msg:'OWASP 2025 A10: File Path Disclosure',\
  severity:'MEDIUM',\
  logdata:'Path Found: %{MATCHED_VAR}',\
  tag:'INFO_LEAKAGE/PATH_DISCLOSURE',\
  tag:'OWASP_2025/A10'"

# 서버 버전 정보 노출 차단
SecRule RESPONSE_HEADERS:Server "@rx (?i)(Apache/[0-9\.]+|nginx/[0-9\.]+|IIS/[0-9\.]+|PHP/[0-9\.]+)" \
  "id:99994003,\
  phase:4,\
  pass,\
  log,\
  msg:'OWASP 2025 A10: Server Version Disclosure',\
  severity:'LOW',\
  logdata:'Server Header: %{MATCHED_VAR}',\
  tag:'INFO_LEAKAGE/VERSION_DISCLOSURE',\
  tag:'OWASP_2025/A10',\
  ctl:responseHeadersAction=append,\
  setvar:'tx.server_header_found=1'"


# --- 5. 추가 보안 규칙 (A03: Injection 방어) ---

# SQL Injection 기본 패턴 차단
SecRule ARGS|REQUEST_BODY "@rx (?i)(\bunion\b.+\bselect\b|'\s*or\s*'?1'?\s*=\s*'?1|;\s*drop\s+table|<script|javascript:)" \
  "id:99995001,\
  phase:2,\
  block,\
  status:403,\
  msg:'OWASP 2025 A03: SQL Injection or XSS Attempt',\
  severity:'CRITICAL',\
  logdata:'Payload: %{MATCHED_VAR}',\
  tag:'WEB_ATTACK/SQL_INJECTION',\
  tag:'OWASP_2025/A03'"

# Command Injection 방어
SecRule ARGS|REQUEST_BODY "@rx (?i)(\||;|`|\$\(|&&|>\s*/|\.\./|/etc/passwd)" \
  "id:99995002,\
  phase:2,\
  block,\
  status:403,\
  msg:'OWASP 2025 A03: Command Injection Attempt',\
  severity:'CRITICAL',\
  logdata:'Payload: %{MATCHED_VAR}',\
  tag:'WEB_ATTACK/COMMAND_INJECTION',\
  tag:'OWASP_2025/A03'"


# --- 6. 모니터링 및 로깅 개선 ---

# 차단된 요청에 대한 상세 로깅
SecRule TX:ANOMALY_SCORE "@gt 0" \
  "id:99996001,\
  phase:5,\
  pass,\
  log,\
  msg:'Request Blocked - Anomaly Score: %{TX.ANOMALY_SCORE}',\
  logdata:'IP: %{REMOTE_ADDR}, URI: %{REQUEST_URI}, User-Agent: %{REQUEST_HEADERS.User-Agent}'"

# 보안 헤더 누락 경고 (응답)
SecRule &RESPONSE_HEADERS:X-Frame-Options "@eq 0" \
  "id:99996002,\
  phase:4,\
  pass,\
  log,\
  msg:'Security Header Missing: X-Frame-Options',\
  severity:'INFO',\
  tag:'SECURITY_HEADER/MISSING'"

SecRule &RESPONSE_HEADERS:X-Content-Type-Options "@eq 0" \
  "id:99996003,\
  phase:4,\
  pass,\
  log,\
  msg:'Security Header Missing: X-Content-Type-Options',\
  severity:'INFO',\
  tag:'SECURITY_HEADER/MISSING'" \
  "id:99991001,\
  phase:2,\
  chain,\
  t:none,\
  msg:'OWASP 2025 A06: CSRF - Missing Referer Header',\
  severity:'CRITICAL',\
  logdata:'Method: %{REQUEST_METHOD}, URI: %{REQUEST_URI}',\
  tag:'WEB_ATTACK/CSRF',\
  tag:'OWASP_2025/A06'"
    SecRule &REQUEST_HEADERS:Referer '@eq 0' \
      "block,\
      status:403"

# CSRF: Referer 도메인 불일치 차단
SecRule REQUEST_METHOD "@rx ^(POST|PUT|DELETE|PATCH)$" \
  "id:99991002,\
  phase:2,\
  chain,\
  t:none,\
  msg:'OWASP 2025 A06: CSRF - Referer Domain Mismatch',\
  severity:'CRITICAL',\
  logdata:'Referer: %{REQUEST_HEADERS.Referer}, Host: %{REQUEST_HEADERS.Host}',\
  tag:'WEB_ATTACK/CSRF',\
  tag:'OWASP_2025/A06'"
    SecRule &REQUEST_HEADERS:Referer "@gt 0" \
      "chain"
        SecRule REQUEST_HEADERS:Referer "!@contains %{REQUEST_HEADERS.Host}" \
          "block,\
          status:403"

# CSRF: GET 요청에서 민감 작업 차단
SecRule REQUEST_METHOD "@streq GET" \
  "id:99991003,\
  phase:2,\
  chain,\
  t:none,\
  msg:'OWASP 2025 A06: State-Changing Operation via GET',\
  severity:'WARNING',\
  tag:'WEB_ATTACK/CSRF',\
  tag:'OWASP_2025/A06'"
    SecRule REQUEST_URI "@rx (?i)(delete|remove|update|modify|add|create|change).*id=" \
      "block,\
      status:405"


# --- 2. A04: 암호화 실패 방어 ---

# 응답 헤더에서 민감 정보 노출 차단
SecRule RESPONSE_HEADERS "@rx (?i)(password|secret|apikey|api[_-]?key|token|credential)" \
  "id:99992001,\
  phase:4,\
  deny,\
  status:500,\
  msg:'OWASP 2025 A04: Sensitive Data in Response Header',\
  severity:'ERROR',\
  logdata:'Header: %{MATCHED_VAR_NAME}',\
  tag:'DATA_LEAKAGE/CRYPTO_FAILURE',\
  tag:'OWASP_2025/A04'"

# HTTP 기본 인증 평문 전송 경고 (Non-HTTPS)
SecRule TX:HTTPS "@eq 0" \
  "id:99992002,\
  phase:1,\
  chain,\
  t:none,\
  msg:'OWASP 2025 A04: Basic Auth over Insecure HTTP',\
  severity:'CRITICAL',\
  logdata:'Auth Header: %{REQUEST_HEADERS.Authorization}',\
  tag:'WEB_ATTACK/CRYPTO_FAILURE',\
  tag:'OWASP_2025/A04'"
    SecRule REQUEST_HEADERS:Authorization "@rx ^Basic\s+" \
      "block,\
      status:426"

# URL 파라미터에 민감 정보 포함 차단
SecRule ARGS_NAMES "@rx (?i)^(password|pwd|passwd|secret|api[_-]?key|token|credit[_-]?card)$" \
  "id:99992003,\
  phase:2,\
  block,\
  status:400,\
  msg:'OWASP 2025 A04: Sensitive Data in URL Parameters',\
  severity:'CRITICAL',\
  logdata:'Parameter: %{MATCHED_VAR_NAME}',\
  tag:'DATA_LEAKAGE/CRYPTO_FAILURE',\
  tag:'OWASP_2025/A04'"

# 민감 엔드포인트 HTTP 접근 차단
SecRule TX:HTTPS "@eq 0" \
  "id:99992004,\
  phase:1,\
  chain,\
  t:none,\
  msg:'OWASP 2025 A04: Insecure Access to Sensitive Endpoint',\
  severity:'HIGH',\
  tag:'CRYPTO_FAILURE',\
  tag:'OWASP_2025/A04'"
    SecRule REQUEST_URI "@rx ^/(login|admin|api|payment|checkout|account)" \
      "block,\
      status:426,\
      logdata:'URI: %{REQUEST_URI}'"


# --- 3. A07: 인증 실패 방어 ---

# 로그인 시도 카운팅
SecRule REQUEST_URI "@rx (?i)/(login|signin|authenticate)" \
  "id:99993001,\
  phase:2,\
  t:none,\
  pass,\
  nolog,\
  setvar:'ip.login_attempt=+1',\
  expirevar:'ip.login_attempt=60'"

# Brute Force 공격 차단 (5회/분)
SecRule IP:login_attempt "@gt 5" \
  "id:99993002,\
  phase:2,\
  deny,\
  status:429,\
  msg:'OWASP 2025 A07: Brute Force Attack Detected',\
  severity:'CRITICAL',\
  logdata:'IP: %{REMOTE_ADDR}, Attempts: %{IP.login_attempt}',\
  tag:'ATTACK/BRUTE_FORCE',\
  tag:'OWASP_2025/A07',\
  setvar:'ip.blocked=1',\
  expirevar:'ip.blocked=300'"

# 의심스러운 긴 세션 토큰 차단
SecRule REQUEST_COOKIES "@rx [A-Za-z0-9]{150,}" \
  "id:99993003,\
  phase:1,\
  block,\
  status:400,\
  msg:'OWASP 2025 A07: Abnormally Long Session Token',\
  severity:'WARNING',\
  logdata:'Cookie Length: %{MATCHED_VAR}',\
  tag:'ATTACK/SESSION_MANAGEMENT',\
  tag:'OWASP_2025/A07'"

# 세션 고정 공격 패턴 탐지
SecRule ARGS:SESSIONID|ARGS:PHPSESSID|ARGS:JSESSIONID "@rx ." \
  "id:99993004,\
  phase:2,\
  block,\
  status:400,\
  msg:'OWASP 2025 A07: Session Fixation Attempt',\
  severity:'HIGH',\
  logdata:'Session ID in URL: %{MATCHED_VAR}',\
  tag:'ATTACK/SESSION_FIXATION',\
  tag:'OWASP_2025/A07'"


# --- 4. A10: 예외 처리 오류 방어 ---

# 상세 기술 오류 메시지 노출 차단
SecRule RESPONSE_BODY "@rx (?i)(stack\s+trace|SQLSTATE|SQLException|ORA-[0-9]{5}|MySQL.*Error|JDBC|Hibernate|Warning:\s+(require|include|fopen)|Fatal\s+error:|Parse\s+error:)" \
  "id:99994001,\
  phase:4,\
  pass,\
  log,\
  msg:'OWASP 2025 A10: Technical Error Details Exposed',\
  severity:'HIGH',\
  logdata:'Error Pattern: %{MATCHED_VAR}',\
  tag:'INFO_LEAKAGE/ERROR_MISHANDLING',\
  tag:'OWASP_2025/A10',\
  setenv:detail_error_detected=1"

# 민감 경로 정보 노출 차단
SecRule RESPONSE_BODY "@rx (?i)(\/var\/www|\/home\/[a-z0-9]+|C:\\\\(inetpub|xampp|wamp)|\/usr\/local)" \
  "id:99994002,\
  phase:4,\
  pass,\
  log,\
  msg:'OWASP 2025 A10: File Path Disclosure',\
  severity:'MEDIUM',\
  logdata:'Path Found: %{MATCHED_VAR}',\
  tag:'INFO_LEAKAGE/PATH_DISCLOSURE',\
  tag:'OWASP_2025/A10'"

# 서버 버전 정보 노출 차단
SecRule RESPONSE_HEADERS:Server "@rx (?i)(Apache/[0-9\.]+|nginx/[0-9\.]+|IIS/[0-9\.]+|PHP/[0-9\.]+)" \
  "id:99994003,\
  phase:4,\
  pass,\
  log,\
  msg:'OWASP 2025 A10: Server Version Disclosure',\
  severity:'LOW',\
  logdata:'Server Header: %{MATCHED_VAR}',\
  tag:'INFO_LEAKAGE/VERSION_DISCLOSURE',\
  tag:'OWASP_2025/A10',\
  ctl:responseHeadersAction=append,\
  setvar:'tx.server_header_found=1'"


# --- 5. 추가 보안 규칙 (A03: Injection 방어) ---

# SQL Injection 기본 패턴 차단
SecRule ARGS|REQUEST_BODY "@rx (?i)(\bunion\b.+\bselect\b|'\s*or\s*'?1'?\s*=\s*'?1|;\s*drop\s+table|<script|javascript:)" \
  "id:99995001,\
  phase:2,\
  block,\
  status:403,\
  msg:'OWASP 2025 A03: SQL Injection or XSS Attempt',\
  severity:'CRITICAL',\
  logdata:'Payload: %{MATCHED_VAR}',\
  tag:'WEB_ATTACK/SQL_INJECTION',\
  tag:'OWASP_2025/A03'"

# Command Injection 방어
SecRule ARGS|REQUEST_BODY "@rx (?i)(\||;|`|\$\(|&&|>\s*/|\.\./|/etc/passwd)" \
  "id:99995002,\
  phase:2,\
  block,\
  status:403,\
  msg:'OWASP 2025 A03: Command Injection Attempt',\
  severity:'CRITICAL',\
  logdata:'Payload: %{MATCHED_VAR}',\
  tag:'WEB_ATTACK/COMMAND_INJECTION',\
  tag:'OWASP_2025/A03'"


# --- 6. 모니터링 및 로깅 개선 ---

# 차단된 요청에 대한 상세 로깅
SecRule TX:ANOMALY_SCORE "@gt 0" \
  "id:99996001,\
  phase:5,\
  pass,\
  log,\
  msg:'Request Blocked - Anomaly Score: %{TX.ANOMALY_SCORE}',\
  logdata:'IP: %{REMOTE_ADDR}, URI: %{REQUEST_URI}, User-Agent: %{REQUEST_HEADERS.User-Agent}'"

# 보안 헤더 누락 경고 (응답)
SecRule &RESPONSE_HEADERS:X-Frame-Options "@eq 0" \
  "id:99996002,\
  phase:4,\
  pass,\
  log,\
  msg:'Security Header Missing: X-Frame-Options',\
  severity:'INFO',\
  tag:'SECURITY_HEADER/MISSING'"

SecRule &RESPONSE_HEADERS:X-Content-Type-Options "@eq 0" \
  "id:99996003,\
  phase:4,\
  pass,\
  log,\
  msg:'Security Header Missing: X-Content-Type-Options',\
  severity:'INFO',\
  tag:'SECURITY_HEADER/MISSING'" \
  "id:99992003,\
  phase:2,\
  block,\
  status:400,\
  msg:'OWASP 2025 A04: Sensitive Data in URL Parameters',\
  severity:'CRITICAL',\
  logdata:'Parameter: %{MATCHED_VAR_NAME}',\
  tag:'DATA_LEAKAGE/CRYPTO_FAILURE',\
  tag:'OWASP_2025/A04'"

# 민감 엔드포인트 HTTP 접근 차단
SecRule TX:HTTPS '@eq 0' \
  "id:99992004,\
  phase:1,\
  chain,\
  t:none,\
  msg:'OWASP 2025 A04: Insecure Access to Sensitive Endpoint',\
  severity:'HIGH',\
  tag:'CRYPTO_FAILURE',\
  tag:'OWASP_2025/A04'"
    SecRule REQUEST_URI '@rx ^/(login|admin|api|payment|checkout|account)' \
      "block,\
      status:426,\
      logdata:'URI: %{REQUEST_URI}'"


# --- 3. A07: 인증 실패 방어 ---

# 로그인 시도 카운팅
SecRule REQUEST_URI "@rx (?i)/(login|signin|authenticate)" \
  "id:99993001,\
  phase:2,\
  t:none,\
  pass,\
  nolog,\
  setvar:'ip.login_attempt=+1',\
  expirevar:'ip.login_attempt=60'"

# Brute Force 공격 차단 (5회/분)
SecRule IP:login_attempt "@gt 5" \
  "id:99993002,\
  phase:2,\
  deny,\
  status:429,\
  msg:'OWASP 2025 A07: Brute Force Attack Detected',\
  severity:'CRITICAL',\
  logdata:'IP: %{REMOTE_ADDR}, Attempts: %{IP.login_attempt}',\
  tag:'ATTACK/BRUTE_FORCE',\
  tag:'OWASP_2025/A07',\
  setvar:'ip.blocked=1',\
  expirevar:'ip.blocked=300'"

# 의심스러운 긴 세션 토큰 차단
SecRule REQUEST_COOKIES "@rx [A-Za-z0-9]{150,}" \
  "id:99993003,\
  phase:1,\
  block,\
  status:400,\
  msg:'OWASP 2025 A07: Abnormally Long Session Token',\
  severity:'WARNING',\
  logdata:'Cookie Length: %{MATCHED_VAR}',\
  tag:'ATTACK/SESSION_MANAGEMENT',\
  tag:'OWASP_2025/A07'"

# 세션 고정 공격 패턴 탐지
SecRule ARGS:SESSIONID|ARGS:PHPSESSID|ARGS:JSESSIONID "@rx ." \
  "id:99993004,\
  phase:2,\
  block,\
  status:400,\
  msg:'OWASP 2025 A07: Session Fixation Attempt',\
  severity:'HIGH',\
  logdata:'Session ID in URL: %{MATCHED_VAR}',\
  tag:'ATTACK/SESSION_FIXATION',\
  tag:'OWASP_2025/A07'"


# --- 4. A10: 예외 처리 오류 방어 ---

# 상세 기술 오류 메시지 노출 차단
SecRule RESPONSE_BODY "@rx (?i)(stack\s+trace|SQLSTATE|SQLException|ORA-[0-9]{5}|MySQL.*Error|JDBC|Hibernate|Warning:\s+(require|include|fopen)|Fatal\s+error:|Parse\s+error:)" \
  "id:99994001,\
  phase:4,\
  pass,\
  log,\
  msg:'OWASP 2025 A10: Technical Error Details Exposed',\
  severity:'HIGH',\
  logdata:'Error Pattern: %{MATCHED_VAR}',\
  tag:'INFO_LEAKAGE/ERROR_MISHANDLING',\
  tag:'OWASP_2025/A10',\
  setenv:detail_error_detected=1"

# 민감 경로 정보 노출 차단
SecRule RESPONSE_BODY "@rx (?i)(\/var\/www|\/home\/[a-z0-9]+|C:\\\\(inetpub|xampp|wamp)|\/usr\/local)" \
  "id:99994002,\
  phase:4,\
  pass,\
  log,\
  msg:'OWASP 2025 A10: File Path Disclosure',\
  severity:'MEDIUM',\
  logdata:'Path Found: %{MATCHED_VAR}',\
  tag:'INFO_LEAKAGE/PATH_DISCLOSURE',\
  tag:'OWASP_2025/A10'"

# 서버 버전 정보 노출 차단
SecRule RESPONSE_HEADERS:Server "@rx (?i)(Apache/[0-9\.]+|nginx/[0-9\.]+|IIS/[0-9\.]+|PHP/[0-9\.]+)" \
  "id:99994003,\
  phase:4,\
  pass,\
  log,\
  msg:'OWASP 2025 A10: Server Version Disclosure',\
  severity:'LOW',\
  logdata:'Server Header: %{MATCHED_VAR}',\
  tag:'INFO_LEAKAGE/VERSION_DISCLOSURE',\
  tag:'OWASP_2025/A10',\
  ctl:responseHeadersAction=append,\
  setvar:'tx.server_header_found=1'"


# --- 5. 추가 보안 규칙 (A03: Injection 방어) ---

# SQL Injection 기본 패턴 차단
SecRule ARGS|REQUEST_BODY "@rx (?i)(\bunion\b.+\bselect\b|'\s*or\s*'?1'?\s*=\s*'?1|;\s*drop\s+table|<script|javascript:)" \
  "id:99995001,\
  phase:2,\
  block,\
  status:403,\
  msg:'OWASP 2025 A03: SQL Injection or XSS Attempt',\
  severity:'CRITICAL',\
  logdata:'Payload: %{MATCHED_VAR}',\
  tag:'WEB_ATTACK/SQL_INJECTION',\
  tag:'OWASP_2025/A03'"

# Command Injection 방어
SecRule ARGS|REQUEST_BODY "@rx (?i)(\||;|`|\$\(|&&|>\s*/|\.\./|/etc/passwd)" \
  "id:99995002,\
  phase:2,\
  block,\
  status:403,\
  msg:'OWASP 2025 A03: Command Injection Attempt',\
  severity:'CRITICAL',\
  logdata:'Payload: %{MATCHED_VAR}',\
  tag:'WEB_ATTACK/COMMAND_INJECTION',\
  tag:'OWASP_2025/A03'"


# --- 6. 모니터링 및 로깅 개선 ---

# 차단된 요청에 대한 상세 로깅
SecRule TX:ANOMALY_SCORE "@gt 0" \
  "id:99996001,\
  phase:5,\
  pass,\
  log,\
  msg:'Request Blocked - Anomaly Score: %{TX.ANOMALY_SCORE}',\
  logdata:'IP: %{REMOTE_ADDR}, URI: %{REQUEST_URI}, User-Agent: %{REQUEST_HEADERS.User-Agent}'"

# 보안 헤더 누락 경고 (응답)
SecRule &RESPONSE_HEADERS:X-Frame-Options "@eq 0" \
  "id:99996002,\
  phase:4,\
  pass,\
  log,\
  msg:'Security Header Missing: X-Frame-Options',\
  severity:'INFO',\
  tag:'SECURITY_HEADER/MISSING'"

SecRule &RESPONSE_HEADERS:X-Content-Type-Options "@eq 0" \
  "id:99996003,\
  phase:4,\
  pass,\
  log,\
  msg:'Security Header Missing: X-Content-Type-Options',\
  severity:'INFO',\
  tag:'SECURITY_HEADER/MISSING'" \
  "id:99991001,\
  phase:2,\
  chain,\
  t:none,\
  msg:'OWASP 2025 A06: CSRF - Missing Referer Header',\
  severity:'CRITICAL',\
  logdata:'Method: %{REQUEST_METHOD}, URI: %{REQUEST_URI}',\
  tag:'WEB_ATTACK/CSRF',\
  tag:'OWASP_2025/A06'"
    SecRule &REQUEST_HEADERS:Referer '@eq 0' \
      "block,\
      status:403"

# CSRF: Referer 도메인 불일치 차단
SecRule REQUEST_METHOD "@rx ^(POST|PUT|DELETE|PATCH)$" \
  "id:99991002,\
  phase:2,\
  chain,\
  t:none,\
  msg:'OWASP 2025 A06: CSRF - Referer Domain Mismatch',\
  severity:'CRITICAL',\
  logdata:'Referer: %{REQUEST_HEADERS.Referer}, Host: %{REQUEST_HEADERS.Host}',\
  tag:'WEB_ATTACK/CSRF',\
  tag:'OWASP_2025/A06'"
    SecRule &REQUEST_HEADERS:Referer "@gt 0" \
      "chain"
        SecRule REQUEST_HEADERS:Referer "!@contains %{REQUEST_HEADERS.Host}" \
          "block,\
          status:403"

# CSRF: GET 요청에서 민감 작업 차단
SecRule REQUEST_METHOD "@streq GET" \
  "id:99991003,\
  phase:2,\
  chain,\
  t:none,\
  msg:'OWASP 2025 A06: State-Changing Operation via GET',\
  severity:'WARNING',\
  tag:'WEB_ATTACK/CSRF',\
  tag:'OWASP_2025/A06'"
    SecRule REQUEST_URI "@rx (?i)(delete|remove|update|modify|add|create|change).*id=" \
      "block,\
      status:405"


# --- 2. A04: 암호화 실패 방어 ---

# 응답 헤더에서 민감 정보 노출 차단
SecRule RESPONSE_HEADERS "@rx (?i)(password|secret|apikey|api[_-]?key|token|credential)" \
  "id:99992001,\
  phase:4,\
  deny,\
  status:500,\
  msg:'OWASP 2025 A04: Sensitive Data in Response Header',\
  severity:'ERROR',\
  logdata:'Header: %{MATCHED_VAR_NAME}',\
  tag:'DATA_LEAKAGE/CRYPTO_FAILURE',\
  tag:'OWASP_2025/A04'"

# HTTP 기본 인증 평문 전송 경고 (Non-HTTPS)
SecRule TX:HTTPS "@eq 0" \
  "id:99992002,\
  phase:1,\
  chain,\
  t:none,\
  msg:'OWASP 2025 A04: Basic Auth over Insecure HTTP',\
  severity:'CRITICAL',\
  logdata:'Auth Header: %{REQUEST_HEADERS.Authorization}',\
  tag:'WEB_ATTACK/CRYPTO_FAILURE',\
  tag:'OWASP_2025/A04'"
    SecRule REQUEST_HEADERS:Authorization "@rx ^Basic\s+" \
      "block,\
      status:426"

# URL 파라미터에 민감 정보 포함 차단
SecRule ARGS_NAMES "@rx (?i)^(password|pwd|passwd|secret|api[_-]?key|token|credit[_-]?card)$" \
  "id:99992003,\
  phase:2,\
  block,\
  status:400,\
  msg:'OWASP 2025 A04: Sensitive Data in URL Parameters',\
  severity:'CRITICAL',\
  logdata:'Parameter: %{MATCHED_VAR_NAME}',\
  tag:'DATA_LEAKAGE/CRYPTO_FAILURE',\
  tag:'OWASP_2025/A04'"

# 민감 엔드포인트 HTTP 접근 차단
SecRule TX:HTTPS "@eq 0" \
  "id:99992004,\
  phase:1,\
  chain,\
  t:none,\
  msg:'OWASP 2025 A04: Insecure Access to Sensitive Endpoint',\
  severity:'HIGH',\
  tag:'CRYPTO_FAILURE',\
  tag:'OWASP_2025/A04'"
    SecRule REQUEST_URI "@rx ^/(login|admin|api|payment|checkout|account)" \
      "block,\
      status:426,\
      logdata:'URI: %{REQUEST_URI}'"


# --- 3. A07: 인증 실패 방어 ---

# 로그인 시도 카운팅
SecRule REQUEST_URI "@rx (?i)/(login|signin|authenticate)" \
  "id:99993001,\
  phase:2,\
  t:none,\
  pass,\
  nolog,\
  setvar:'ip.login_attempt=+1',\
  expirevar:'ip.login_attempt=60'"

# Brute Force 공격 차단 (5회/분)
SecRule IP:login_attempt "@gt 5" \
  "id:99993002,\
  phase:2,\
  deny,\
  status:429,\
  msg:'OWASP 2025 A07: Brute Force Attack Detected',\
  severity:'CRITICAL',\
  logdata:'IP: %{REMOTE_ADDR}, Attempts: %{IP.login_attempt}',\
  tag:'ATTACK/BRUTE_FORCE',\
  tag:'OWASP_2025/A07',\
  setvar:'ip.blocked=1',\
  expirevar:'ip.blocked=300'"

# 의심스러운 긴 세션 토큰 차단
SecRule REQUEST_COOKIES "@rx [A-Za-z0-9]{150,}" \
  "id:99993003,\
  phase:1,\
  block,\
  status:400,\
  msg:'OWASP 2025 A07: Abnormally Long Session Token',\
  severity:'WARNING',\
  logdata:'Cookie Length: %{MATCHED_VAR}',\
  tag:'ATTACK/SESSION_MANAGEMENT',\
  tag:'OWASP_2025/A07'"

# 세션 고정 공격 패턴 탐지
SecRule ARGS:SESSIONID|ARGS:PHPSESSID|ARGS:JSESSIONID "@rx ." \
  "id:99993004,\
  phase:2,\
  block,\
  status:400,\
  msg:'OWASP 2025 A07: Session Fixation Attempt',\
  severity:'HIGH',\
  logdata:'Session ID in URL: %{MATCHED_VAR}',\
  tag:'ATTACK/SESSION_FIXATION',\
  tag:'OWASP_2025/A07'"


# --- 4. A10: 예외 처리 오류 방어 ---

# 상세 기술 오류 메시지 노출 차단
SecRule RESPONSE_BODY "@rx (?i)(stack\s+trace|SQLSTATE|SQLException|ORA-[0-9]{5}|MySQL.*Error|JDBC|Hibernate|Warning:\s+(require|include|fopen)|Fatal\s+error:|Parse\s+error:)" \
  "id:99994001,\
  phase:4,\
  pass,\
  log,\
  msg:'OWASP 2025 A10: Technical Error Details Exposed',\
  severity:'HIGH',\
  logdata:'Error Pattern: %{MATCHED_VAR}',\
  tag:'INFO_LEAKAGE/ERROR_MISHANDLING',\
  tag:'OWASP_2025/A10',\
  setenv:detail_error_detected=1"

# 민감 경로 정보 노출 차단
SecRule RESPONSE_BODY "@rx (?i)(\/var\/www|\/home\/[a-z0-9]+|C:\\\\(inetpub|xampp|wamp)|\/usr\/local)" \
  "id:99994002,\
  phase:4,\
  pass,\
  log,\
  msg:'OWASP 2025 A10: File Path Disclosure',\
  severity:'MEDIUM',\
  logdata:'Path Found: %{MATCHED_VAR}',\
  tag:'INFO_LEAKAGE/PATH_DISCLOSURE',\
  tag:'OWASP_2025/A10'"

# 서버 버전 정보 노출 차단
SecRule RESPONSE_HEADERS:Server "@rx (?i)(Apache/[0-9\.]+|nginx/[0-9\.]+|IIS/[0-9\.]+|PHP/[0-9\.]+)" \
  "id:99994003,\
  phase:4,\
  pass,\
  log,\
  msg:'OWASP 2025 A10: Server Version Disclosure',\
  severity:'LOW',\
  logdata:'Server Header: %{MATCHED_VAR}',\
  tag:'INFO_LEAKAGE/VERSION_DISCLOSURE',\
  tag:'OWASP_2025/A10',\
  ctl:responseHeadersAction=append,\
  setvar:'tx.server_header_found=1'"


# --- 5. 추가 보안 규칙 (A03: Injection 방어) ---

# SQL Injection 기본 패턴 차단
SecRule ARGS|REQUEST_BODY "@rx (?i)(\bunion\b.+\bselect\b|'\s*or\s*'?1'?\s*=\s*'?1|;\s*drop\s+table|<script|javascript:)" \
  "id:99995001,\
  phase:2,\
  block,\
  status:403,\
  msg:'OWASP 2025 A03: SQL Injection or XSS Attempt',\
  severity:'CRITICAL',\
  logdata:'Payload: %{MATCHED_VAR}',\
  tag:'WEB_ATTACK/SQL_INJECTION',\
  tag:'OWASP_2025/A03'"

# Command Injection 방어
SecRule ARGS|REQUEST_BODY "@rx (?i)(\||;|`|\$\(|&&|>\s*/|\.\./|/etc/passwd)" \
  "id:99995002,\
  phase:2,\
  block,\
  status:403,\
  msg:'OWASP 2025 A03: Command Injection Attempt',\
  severity:'CRITICAL',\
  logdata:'Payload: %{MATCHED_VAR}',\
  tag:'WEB_ATTACK/COMMAND_INJECTION',\
  tag:'OWASP_2025/A03'"


# --- 6. 모니터링 및 로깅 개선 ---

# 차단된 요청에 대한 상세 로깅
SecRule TX:ANOMALY_SCORE "@gt 0" \
  "id:99996001,\
  phase:5,\
  pass,\
  log,\
  msg:'Request Blocked - Anomaly Score: %{TX.ANOMALY_SCORE}',\
  logdata:'IP: %{REMOTE_ADDR}, URI: %{REQUEST_URI}, User-Agent: %{REQUEST_HEADERS.User-Agent}'"

# 보안 헤더 누락 경고 (응답)
SecRule &RESPONSE_HEADERS:X-Frame-Options "@eq 0" \
  "id:99996002,\
  phase:4,\
  pass,\
  log,\
  msg:'Security Header Missing: X-Frame-Options',\
  severity:'INFO',\
  tag:'SECURITY_HEADER/MISSING'"

SecRule &RESPONSE_HEADERS:X-Content-Type-Options "@eq 0" \
  "id:99996003,\
  phase:4,\
  pass,\
  log,\
  msg:'Security Header Missing: X-Content-Type-Options',\
  severity:'INFO',\
  tag:'SECURITY_HEADER/MISSING'" \
  "id:99991002,\
  phase:2,\
  chain,\
  t:none,\
  msg:'OWASP 2025 A06: CSRF - Referer Domain Mismatch',\
  severity:'CRITICAL',\
  logdata:'Referer: %{REQUEST_HEADERS.Referer}, Host: %{REQUEST_HEADERS.Host}',\
  tag:'WEB_ATTACK/CSRF',\
  tag:'OWASP_2025/A06'"
    SecRule &REQUEST_HEADERS:Referer '@gt 0' \
      "chain"
        SecRule REQUEST_HEADERS:Referer '!@contains %{REQUEST_HEADERS.Host}' \
          "block,\
          status:403"

# CSRF: GET 요청에서 민감 작업 차단
SecRule REQUEST_METHOD '@streq GET' \
  "id:99991003,\
  phase:2,\
  chain,\
  t:none,\
  msg:'OWASP 2025 A06: State-Changing Operation via GET',\
  severity:'WARNING',\
  tag:'WEB_ATTACK/CSRF',\
  tag:'OWASP_2025/A06'"
    SecRule REQUEST_URI '@rx (?i)(delete|remove|update|modify|add|create|change).*id=' \
      "block,\
      status:405"


# --- 2. A04: 암호화 실패 방어 ---

# 응답 헤더에서 민감 정보 노출 차단
SecRule RESPONSE_HEADERS "@rx (?i)(password|secret|apikey|api[_-]?key|token|credential)" \
  "id:99992001,\
  phase:4,\
  deny,\
  status:500,\
  msg:'OWASP 2025 A04: Sensitive Data in Response Header',\
  severity:'ERROR',\
  logdata:'Header: %{MATCHED_VAR_NAME}',\
  tag:'DATA_LEAKAGE/CRYPTO_FAILURE',\
  tag:'OWASP_2025/A04'"

# HTTP 기본 인증 평문 전송 경고 (Non-HTTPS)
SecRule TX:HTTPS "@eq 0" \
  "id:99992002,\
  phase:1,\
  chain,\
  t:none,\
  msg:'OWASP 2025 A04: Basic Auth over Insecure HTTP',\
  severity:'CRITICAL',\
  logdata:'Auth Header: %{REQUEST_HEADERS.Authorization}',\
  tag:'WEB_ATTACK/CRYPTO_FAILURE',\
  tag:'OWASP_2025/A04'"
    SecRule REQUEST_HEADERS:Authorization "@rx ^Basic\s+" \
      "block,\
      status:426"

# URL 파라미터에 민감 정보 포함 차단
SecRule ARGS_NAMES "@rx (?i)^(password|pwd|passwd|secret|api[_-]?key|token|credit[_-]?card)$" \
  "id:99992003,\
  phase:2,\
  block,\
  status:400,\
  msg:'OWASP 2025 A04: Sensitive Data in URL Parameters',\
  severity:'CRITICAL',\
  logdata:'Parameter: %{MATCHED_VAR_NAME}',\
  tag:'DATA_LEAKAGE/CRYPTO_FAILURE',\
  tag:'OWASP_2025/A04'"

# 민감 엔드포인트 HTTP 접근 차단
SecRule TX:HTTPS "@eq 0" \
  "id:99992004,\
  phase:1,\
  chain,\
  t:none,\
  msg:'OWASP 2025 A04: Insecure Access to Sensitive Endpoint',\
  severity:'HIGH',\
  tag:'CRYPTO_FAILURE',\
  tag:'OWASP_2025/A04'"
    SecRule REQUEST_URI "@rx ^/(login|admin|api|payment|checkout|account)" \
      "block,\
      status:426,\
      logdata:'URI: %{REQUEST_URI}'"


# --- 3. A07: 인증 실패 방어 ---

# 로그인 시도 카운팅
SecRule REQUEST_URI "@rx (?i)/(login|signin|authenticate)" \
  "id:99993001,\
  phase:2,\
  t:none,\
  pass,\
  nolog,\
  setvar:'ip.login_attempt=+1',\
  expirevar:'ip.login_attempt=60'"

# Brute Force 공격 차단 (5회/분)
SecRule IP:login_attempt "@gt 5" \
  "id:99993002,\
  phase:2,\
  deny,\
  status:429,\
  msg:'OWASP 2025 A07: Brute Force Attack Detected',\
  severity:'CRITICAL',\
  logdata:'IP: %{REMOTE_ADDR}, Attempts: %{IP.login_attempt}',\
  tag:'ATTACK/BRUTE_FORCE',\
  tag:'OWASP_2025/A07',\
  setvar:'ip.blocked=1',\
  expirevar:'ip.blocked=300'"

# 의심스러운 긴 세션 토큰 차단
SecRule REQUEST_COOKIES "@rx [A-Za-z0-9]{150,}" \
  "id:99993003,\
  phase:1,\
  block,\
  status:400,\
  msg:'OWASP 2025 A07: Abnormally Long Session Token',\
  severity:'WARNING',\
  logdata:'Cookie Length: %{MATCHED_VAR}',\
  tag:'ATTACK/SESSION_MANAGEMENT',\
  tag:'OWASP_2025/A07'"

# 세션 고정 공격 패턴 탐지
SecRule ARGS:SESSIONID|ARGS:PHPSESSID|ARGS:JSESSIONID "@rx ." \
  "id:99993004,\
  phase:2,\
  block,\
  status:400,\
  msg:'OWASP 2025 A07: Session Fixation Attempt',\
  severity:'HIGH',\
  logdata:'Session ID in URL: %{MATCHED_VAR}',\
  tag:'ATTACK/SESSION_FIXATION',\
  tag:'OWASP_2025/A07'"


# --- 4. A10: 예외 처리 오류 방어 ---

# 상세 기술 오류 메시지 노출 차단
SecRule RESPONSE_BODY "@rx (?i)(stack\s+trace|SQLSTATE|SQLException|ORA-[0-9]{5}|MySQL.*Error|JDBC|Hibernate|Warning:\s+(require|include|fopen)|Fatal\s+error:|Parse\s+error:)" \
  "id:99994001,\
  phase:4,\
  pass,\
  log,\
  msg:'OWASP 2025 A10: Technical Error Details Exposed',\
  severity:'HIGH',\
  logdata:'Error Pattern: %{MATCHED_VAR}',\
  tag:'INFO_LEAKAGE/ERROR_MISHANDLING',\
  tag:'OWASP_2025/A10',\
  setenv:detail_error_detected=1"

# 민감 경로 정보 노출 차단
SecRule RESPONSE_BODY "@rx (?i)(\/var\/www|\/home\/[a-z0-9]+|C:\\\\(inetpub|xampp|wamp)|\/usr\/local)" \
  "id:99994002,\
  phase:4,\
  pass,\
  log,\
  msg:'OWASP 2025 A10: File Path Disclosure',\
  severity:'MEDIUM',\
  logdata:'Path Found: %{MATCHED_VAR}',\
  tag:'INFO_LEAKAGE/PATH_DISCLOSURE',\
  tag:'OWASP_2025/A10'"

# 서버 버전 정보 노출 차단
SecRule RESPONSE_HEADERS:Server "@rx (?i)(Apache/[0-9\.]+|nginx/[0-9\.]+|IIS/[0-9\.]+|PHP/[0-9\.]+)" \
  "id:99994003,\
  phase:4,\
  pass,\
  log,\
  msg:'OWASP 2025 A10: Server Version Disclosure',\
  severity:'LOW',\
  logdata:'Server Header: %{MATCHED_VAR}',\
  tag:'INFO_LEAKAGE/VERSION_DISCLOSURE',\
  tag:'OWASP_2025/A10',\
  ctl:responseHeadersAction=append,\
  setvar:'tx.server_header_found=1'"


# --- 5. 추가 보안 규칙 (A03: Injection 방어) ---

# SQL Injection 기본 패턴 차단
SecRule ARGS|REQUEST_BODY "@rx (?i)(\bunion\b.+\bselect\b|'\s*or\s*'?1'?\s*=\s*'?1|;\s*drop\s+table|<script|javascript:)" \
  "id:99995001,\
  phase:2,\
  block,\
  status:403,\
  msg:'OWASP 2025 A03: SQL Injection or XSS Attempt',\
  severity:'CRITICAL',\
  logdata:'Payload: %{MATCHED_VAR}',\
  tag:'WEB_ATTACK/SQL_INJECTION',\
  tag:'OWASP_2025/A03'"

# Command Injection 방어
SecRule ARGS|REQUEST_BODY "@rx (?i)(\||;|`|\$\(|&&|>\s*/|\.\./|/etc/passwd)" \
  "id:99995002,\
  phase:2,\
  block,\
  status:403,\
  msg:'OWASP 2025 A03: Command Injection Attempt',\
  severity:'CRITICAL',\
  logdata:'Payload: %{MATCHED_VAR}',\
  tag:'WEB_ATTACK/COMMAND_INJECTION',\
  tag:'OWASP_2025/A03'"


# --- 6. 모니터링 및 로깅 개선 ---

# 차단된 요청에 대한 상세 로깅
SecRule TX:ANOMALY_SCORE "@gt 0" \
  "id:99996001,\
  phase:5,\
  pass,\
  log,\
  msg:'Request Blocked - Anomaly Score: %{TX.ANOMALY_SCORE}',\
  logdata:'IP: %{REMOTE_ADDR}, URI: %{REQUEST_URI}, User-Agent: %{REQUEST_HEADERS.User-Agent}'"

# 보안 헤더 누락 경고 (응답)
SecRule &RESPONSE_HEADERS:X-Frame-Options "@eq 0" \
  "id:99996002,\
  phase:4,\
  pass,\
  log,\
  msg:'Security Header Missing: X-Frame-Options',\
  severity:'INFO',\
  tag:'SECURITY_HEADER/MISSING'"

SecRule &RESPONSE_HEADERS:X-Content-Type-Options "@eq 0" \
  "id:99996003,\
  phase:4,\
  pass,\
  log,\
  msg:'Security Header Missing: X-Content-Type-Options',\
  severity:'INFO',\
  tag:'SECURITY_HEADER/MISSING'" \
  "id:99991001,\
  phase:2,\
  chain,\
  t:none,\
  msg:'OWASP 2025 A06: CSRF - Missing Referer Header',\
  severity:'CRITICAL',\
  logdata:'Method: %{REQUEST_METHOD}, URI: %{REQUEST_URI}',\
  tag:'WEB_ATTACK/CSRF',\
  tag:'OWASP_2025/A06'"
    SecRule &REQUEST_HEADERS:Referer '@eq 0' \
      "block,\
      status:403"

# CSRF: Referer 도메인 불일치 차단
SecRule REQUEST_METHOD "@rx ^(POST|PUT|DELETE|PATCH)$" \
  "id:99991002,\
  phase:2,\
  chain,\
  t:none,\
  msg:'OWASP 2025 A06: CSRF - Referer Domain Mismatch',\
  severity:'CRITICAL',\
  logdata:'Referer: %{REQUEST_HEADERS.Referer}, Host: %{REQUEST_HEADERS.Host}',\
  tag:'WEB_ATTACK/CSRF',\
  tag:'OWASP_2025/A06'"
    SecRule &REQUEST_HEADERS:Referer "@gt 0" \
      "chain"
        SecRule REQUEST_HEADERS:Referer "!@contains %{REQUEST_HEADERS.Host}" \
          "block,\
          status:403"

# CSRF: GET 요청에서 민감 작업 차단
SecRule REQUEST_METHOD "@streq GET" \
  "id:99991003,\
  phase:2,\
  chain,\
  t:none,\
  msg:'OWASP 2025 A06: State-Changing Operation via GET',\
  severity:'WARNING',\
  tag:'WEB_ATTACK/CSRF',\
  tag:'OWASP_2025/A06'"
    SecRule REQUEST_URI "@rx (?i)(delete|remove|update|modify|add|create|change).*id=" \
      "block,\
      status:405"


# --- 2. A04: 암호화 실패 방어 ---

# 응답 헤더에서 민감 정보 노출 차단
SecRule RESPONSE_HEADERS "@rx (?i)(password|secret|apikey|api[_-]?key|token|credential)" \
  "id:99992001,\
  phase:4,\
  deny,\
  status:500,\
  msg:'OWASP 2025 A04: Sensitive Data in Response Header',\
  severity:'ERROR',\
  logdata:'Header: %{MATCHED_VAR_NAME}',\
  tag:'DATA_LEAKAGE/CRYPTO_FAILURE',\
  tag:'OWASP_2025/A04'"

# HTTP 기본 인증 평문 전송 경고 (Non-HTTPS)
SecRule TX:HTTPS "@eq 0" \
  "id:99992002,\
  phase:1,\
  chain,\
  t:none,\
  msg:'OWASP 2025 A04: Basic Auth over Insecure HTTP',\
  severity:'CRITICAL',\
  logdata:'Auth Header: %{REQUEST_HEADERS.Authorization}',\
  tag:'WEB_ATTACK/CRYPTO_FAILURE',\
  tag:'OWASP_2025/A04'"
    SecRule REQUEST_HEADERS:Authorization "@rx ^Basic\s+" \
      "block,\
      status:426"

# URL 파라미터에 민감 정보 포함 차단
SecRule ARGS_NAMES "@rx (?i)^(password|pwd|passwd|secret|api[_-]?key|token|credit[_-]?card)$" \
  "id:99992003,\
  phase:2,\
  block,\
  status:400,\
  msg:'OWASP 2025 A04: Sensitive Data in URL Parameters',\
  severity:'CRITICAL',\
  logdata:'Parameter: %{MATCHED_VAR_NAME}',\
  tag:'DATA_LEAKAGE/CRYPTO_FAILURE',\
  tag:'OWASP_2025/A04'"

# 민감 엔드포인트 HTTP 접근 차단
SecRule TX:HTTPS "@eq 0" \
  "id:99992004,\
  phase:1,\
  chain,\
  t:none,\
  msg:'OWASP 2025 A04: Insecure Access to Sensitive Endpoint',\
  severity:'HIGH',\
  tag:'CRYPTO_FAILURE',\
  tag:'OWASP_2025/A04'"
    SecRule REQUEST_URI "@rx ^/(login|admin|api|payment|checkout|account)" \
      "block,\
      status:426,\
      logdata:'URI: %{REQUEST_URI}'"


# --- 3. A07: 인증 실패 방어 ---

# 로그인 시도 카운팅
SecRule REQUEST_URI "@rx (?i)/(login|signin|authenticate)" \
  "id:99993001,\
  phase:2,\
  t:none,\
  pass,\
  nolog,\
  setvar:'ip.login_attempt=+1',\
  expirevar:'ip.login_attempt=60'"

# Brute Force 공격 차단 (5회/분)
SecRule IP:login_attempt "@gt 5" \
  "id:99993002,\
  phase:2,\
  deny,\
  status:429,\
  msg:'OWASP 2025 A07: Brute Force Attack Detected',\
  severity:'CRITICAL',\
  logdata:'IP: %{REMOTE_ADDR}, Attempts: %{IP.login_attempt}',\
  tag:'ATTACK/BRUTE_FORCE',\
  tag:'OWASP_2025/A07',\
  setvar:'ip.blocked=1',\
  expirevar:'ip.blocked=300'"

# 의심스러운 긴 세션 토큰 차단
SecRule REQUEST_COOKIES "@rx [A-Za-z0-9]{150,}" \
  "id:99993003,\
  phase:1,\
  block,\
  status:400,\
  msg:'OWASP 2025 A07: Abnormally Long Session Token',\
  severity:'WARNING',\
  logdata:'Cookie Length: %{MATCHED_VAR}',\
  tag:'ATTACK/SESSION_MANAGEMENT',\
  tag:'OWASP_2025/A07'"

# 세션 고정 공격 패턴 탐지
SecRule ARGS:SESSIONID|ARGS:PHPSESSID|ARGS:JSESSIONID "@rx ." \
  "id:99993004,\
  phase:2,\
  block,\
  status:400,\
  msg:'OWASP 2025 A07: Session Fixation Attempt',\
  severity:'HIGH',\
  logdata:'Session ID in URL: %{MATCHED_VAR}',\
  tag:'ATTACK/SESSION_FIXATION',\
  tag:'OWASP_2025/A07'"


# --- 4. A10: 예외 처리 오류 방어 ---

# 상세 기술 오류 메시지 노출 차단
SecRule RESPONSE_BODY "@rx (?i)(stack\s+trace|SQLSTATE|SQLException|ORA-[0-9]{5}|MySQL.*Error|JDBC|Hibernate|Warning:\s+(require|include|fopen)|Fatal\s+error:|Parse\s+error:)" \
  "id:99994001,\
  phase:4,\
  pass,\
  log,\
  msg:'OWASP 2025 A10: Technical Error Details Exposed',\
  severity:'HIGH',\
  logdata:'Error Pattern: %{MATCHED_VAR}',\
  tag:'INFO_LEAKAGE/ERROR_MISHANDLING',\
  tag:'OWASP_2025/A10',\
  setenv:detail_error_detected=1"

# 민감 경로 정보 노출 차단
SecRule RESPONSE_BODY "@rx (?i)(\/var\/www|\/home\/[a-z0-9]+|C:\\\\(inetpub|xampp|wamp)|\/usr\/local)" \
  "id:99994002,\
  phase:4,\
  pass,\
  log,\
  msg:'OWASP 2025 A10: File Path Disclosure',\
  severity:'MEDIUM',\
  logdata:'Path Found: %{MATCHED_VAR}',\
  tag:'INFO_LEAKAGE/PATH_DISCLOSURE',\
  tag:'OWASP_2025/A10'"

# 서버 버전 정보 노출 차단
SecRule RESPONSE_HEADERS:Server "@rx (?i)(Apache/[0-9\.]+|nginx/[0-9\.]+|IIS/[0-9\.]+|PHP/[0-9\.]+)" \
  "id:99994003,\
  phase:4,\
  pass,\
  log,\
  msg:'OWASP 2025 A10: Server Version Disclosure',\
  severity:'LOW',\
  logdata:'Server Header: %{MATCHED_VAR}',\
  tag:'INFO_LEAKAGE/VERSION_DISCLOSURE',\
  tag:'OWASP_2025/A10',\
  ctl:responseHeadersAction=append,\
  setvar:'tx.server_header_found=1'"


# --- 5. 추가 보안 규칙 (A03: Injection 방어) ---

# SQL Injection 기본 패턴 차단
SecRule ARGS|REQUEST_BODY "@rx (?i)(\bunion\b.+\bselect\b|'\s*or\s*'?1'?\s*=\s*'?1|;\s*drop\s+table|<script|javascript:)" \
  "id:99995001,\
  phase:2,\
  block,\
  status:403,\
  msg:'OWASP 2025 A03: SQL Injection or XSS Attempt',\
  severity:'CRITICAL',\
  logdata:'Payload: %{MATCHED_VAR}',\
  tag:'WEB_ATTACK/SQL_INJECTION',\
  tag:'OWASP_2025/A03'"

# Command Injection 방어
SecRule ARGS|REQUEST_BODY "@rx (?i)(\||;|`|\$\(|&&|>\s*/|\.\./|/etc/passwd)" \
  "id:99995002,\
  phase:2,\
  block,\
  status:403,\
  msg:'OWASP 2025 A03: Command Injection Attempt',\
  severity:'CRITICAL',\
  logdata:'Payload: %{MATCHED_VAR}',\
  tag:'WEB_ATTACK/COMMAND_INJECTION',\
  tag:'OWASP_2025/A03'"


# --- 6. 모니터링 및 로깅 개선 ---

# 차단된 요청에 대한 상세 로깅
SecRule TX:ANOMALY_SCORE "@gt 0" \
  "id:99996001,\
  phase:5,\
  pass,\
  log,\
  msg:'Request Blocked - Anomaly Score: %{TX.ANOMALY_SCORE}',\
  logdata:'IP: %{REMOTE_ADDR}, URI: %{REQUEST_URI}, User-Agent: %{REQUEST_HEADERS.User-Agent}'"

# 보안 헤더 누락 경고 (응답)
SecRule &RESPONSE_HEADERS:X-Frame-Options "@eq 0" \
  "id:99996002,\
  phase:4,\
  pass,\
  log,\
  msg:'Security Header Missing: X-Frame-Options',\
  severity:'INFO',\
  tag:'SECURITY_HEADER/MISSING'"

SecRule &RESPONSE_HEADERS:X-Content-Type-Options "@eq 0" \
  "id:99996003,\
  phase:4,\
  pass,\
  log,\
  msg:'Security Header Missing: X-Content-Type-Options',\
  severity:'INFO',\
  tag:'SECURITY_HEADER/MISSING'"